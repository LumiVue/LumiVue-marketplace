<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Shopping Cart - LumiVue</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />

    <style>
        :root {
            --lv-bg: #f4f1eb;
            --lv-surface: #ffffff;
            --lv-border: #ddd3c6;
            --lv-border-strong: #ccc0b1;
            --lv-text: #2c1e19;
            --lv-text-muted: #7a6a5c;
            --lv-accent: #c98a5a;
            --lv-accent-soft: #fbede1;
            --lv-radius-lg: 14px;
            --lv-shadow-soft: 0 24px 60px rgba(15, 23, 42, 0.18);
            --lv-success: #16a34a;
            --lv-danger: #dc2626;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background: var(--lv-bg);
            color: var(--lv-text);
        }

        .lv-page {
            min-height: 100vh;
        }

        .lv-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(244, 241, 235, 0.98);
            backdrop-filter: blur(18px);
            border-bottom: 1px solid rgba(221, 211, 198, 0.7);
        }

        .lv-header-inner {
            max-width: 1120px;
            margin: 0 auto;
            padding: 10px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .lv-logo-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lv-logo-circle {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: #e6d8c7;
            color: var(--lv-text);
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--lv-border-strong);
        }

        .lv-logo-text {
            font-size: 14px;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            color: var(--lv-text);
        }

        .lv-nav {
            display: flex;
            align-items: center;
            gap: 18px;
            font-size: 14px;
        }

        .lv-nav a {
            text-decoration: none;
            color: var(--lv-text);
        }

        .lv-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lv-cart-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 34px;
            width: 34px;
            padding: 0;
            border-radius: 50%;
            background: #e6d8c7;
            color: var(--lv-text);
            font-weight: 600;
            font-size: 18px;
            border: 1px solid var(--lv-border-strong);
            cursor: pointer;
            text-decoration: none;
        }

        .lv-cart-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--lv-accent);
            color: #ffffff;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            border: 2px solid var(--lv-bg);
        }

        .lv-btn-text, .lv-btn-soft {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 34px;
            padding: 0 18px;
            border-radius: 50px;
            background: #e6d8c7;
            color: var(--lv-text);
            font-weight: 600;
            font-size: 14px;
            border: 1px solid var(--lv-border-strong);
            cursor: pointer;
            text-decoration: none;
        }

        .lv-main {
            max-width: 1120px;
            margin: 40px auto;
            padding: 0 24px;
        }

        .lv-cart-header {
            margin-bottom: 32px;
        }

        .lv-cart-title {
            font-size: 32px;
            font-weight: 700;
            margin: 0 0 8px;
        }

        .lv-cart-subtitle {
            font-size: 14px;
            color: var(--lv-text-muted);
        }

        .lv-cart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            align-items: flex-start;
        }

        @media (max-width: 960px) {
            .lv-cart-grid {
                grid-template-columns: 1fr;
            }
        }

        .lv-cart-card {
            background: var(--lv-surface);
            border-radius: 26px;
            padding: 24px;
            box-shadow: var(--lv-shadow-soft);
            border: 1px solid var(--lv-border);
        }

        .lv-cart-card-title {
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 20px;
        }

        .lv-cart-item {
            display: flex;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--lv-border);
        }

        .lv-cart-item:last-child {
            border-bottom: none;
        }

        .lv-cart-item-image {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            background: var(--lv-border);
        }

        .lv-cart-item-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .lv-cart-item-title {
            font-size: 15px;
            font-weight: 600;
            margin: 0;
        }

        .lv-cart-item-subtitle {
            font-size: 13px;
            color: var(--lv-text-muted);
            margin: 0;
        }

        .lv-cart-item-vendor {
            font-size: 12px;
            color: var(--lv-text-muted);
        }

        .lv-cart-item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .lv-qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--lv-border-strong);
            background: var(--lv-surface);
            color: var(--lv-text);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lv-qty-display {
            font-size: 14px;
            font-weight: 600;
            min-width: 32px;
            text-align: center;
        }

        .lv-remove-btn {
            padding: 4px 12px;
            border-radius: 6px;
            border: 1px solid var(--lv-border-strong);
            background: var(--lv-surface);
            color: var(--lv-danger);
            font-size: 12px;
            cursor: pointer;
            margin-left: auto;
        }

        .lv-cart-item-price {
            font-size: 15px;
            font-weight: 600;
            text-align: right;
        }

        .lv-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            font-size: 14px;
        }

        .lv-summary-row.total {
            font-size: 20px;
            font-weight: 700;
            padding-top: 16px;
            border-top: 2px solid var(--lv-border);
            margin-top: 8px;
        }

        .lv-btn-primary {
            width: 100%;
            border-radius: 12px;
            border: none;
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            background: var(--lv-accent);
            color: #ffffff;
            cursor: pointer;
            margin-top: 16px;
        }

        .lv-btn-secondary {
            width: 100%;
            border-radius: 12px;
            border: 1px solid var(--lv-border-strong);
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            background: var(--lv-surface);
            color: var(--lv-text);
            cursor: pointer;
            margin-top: 12px;
        }

        .lv-empty-cart {
            text-align: center;
            padding: 60px 20px;
        }

        .lv-empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .lv-empty-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .lv-empty-text {
            font-size: 14px;
            color: var(--lv-text-muted);
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .lv-main {
                padding: 0 16px;
            }

            .lv-cart-item {
                flex-direction: column;
            }

            .lv-cart-item-image {
                width: 100%;
                height: 200px;
            }
        }
    </style>
</head>

<body>
    <div class="lv-page">
        <header class="lv-header">
            <div class="lv-header-inner">
                <div class="lv-logo-wrap">
                    <div class="lv-logo-circle">LV</div>
                    <span class="lv-logo-text">LUMIVUE</span>
                </div>

                <nav class="lv-nav">
                    <a href="marketplace.html">Marketplace</a>
                    <a href="Index.html">Browse all</a>
                </nav>

                <div class="lv-header-actions">
                    <a class="lv-cart-btn" href="cart.html" title="Shopping Cart">
                        &#128722;
                        <span class="lv-cart-count">0</span>
                    </a>
                    <a class="lv-btn-text" href="login.html">Sign in / Join</a>
                    <a class="lv-btn-soft" href="login.html">For vendors</a>
                </div>
            </div>
        </header>

        <main class="lv-main">
            <div class="lv-cart-header">
                <h1 class="lv-cart-title">Shopping Cart</h1>
                <p class="lv-cart-subtitle" id="cartSubtitle">Loading your cart...</p>
            </div>

            <div id="emptyCart" class="lv-empty-cart" style="display:none;">
                <div class="lv-empty-icon">??</div>
                <h2 class="lv-empty-title">Your cart is empty</h2>
                <p class="lv-empty-text">Add some beautiful products from our indie creators!</p>
                <button class="lv-btn-primary" onclick="window.location.href='marketplace.html'">
                    Browse Marketplace
                </button>
            </div>

            <div id="cartContent" class="lv-cart-grid" style="display:none;">
                <!-- Cart Items -->
                <div class="lv-cart-card">
                    <h2 class="lv-cart-card-title">Cart Items</h2>
                    <div id="cartItemsList"></div>
                </div>

                <!-- Order Summary -->
                <div class="lv-cart-card">
                    <h2 class="lv-cart-card-title">Order Summary</h2>
                    <div class="lv-summary-row">
                        <span>Subtotal</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="lv-summary-row">
                        <span>Shipping</span>
                        <span>Calculated at checkout</span>
                    </div>
                    <div class="lv-summary-row total">
                        <span>Total</span>
                        <span id="total">$0.00</span>
                    </div>
                    <button class="lv-btn-primary" id="checkoutBtn" onclick="proceedToCheckout()">
                        Proceed to Checkout
                    </button>
                    <button class="lv-btn-secondary" onclick="window.location.href='marketplace.html'">
                        Continue Shopping
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <!-- Cart Utility -->
    <script src="cart.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAMmOyBqyPr5KoIzqnItE4sH1lb83iQAo8",
            authDomain: "lumivue-c8fdf.firebaseapp.com",
            projectId: "lumivue-c8fdf",
            storageBucket: "lumivue-c8fdf.firebasestorage.app",
            messagingSenderId: "120420036736",
            appId: "1:120420036736:web:0fbbc98b02ea54840d3665"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Initialize cart
        cart.init(auth, db);

        // Render cart items
        function renderCart() {
            const items = cart.getCartItems();
            const cartItemsList = document.getElementById('cartItemsList');
            const emptyCart = document.getElementById('emptyCart');
            const cartContent = document.getElementById('cartContent');
            const cartSubtitle = document.getElementById('cartSubtitle');

            if (items.length === 0) {
                emptyCart.style.display = 'block';
                cartContent.style.display = 'none';
                cartSubtitle.textContent = 'Your cart is empty';
                return;
            }

            emptyCart.style.display = 'none';
            cartContent.style.display = 'grid';
            cartSubtitle.textContent = `${items.length} item${items.length !== 1 ? 's' : ''} in your cart`;

            cartItemsList.innerHTML = '';

            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'lv-cart-item';

                const currency = item.currency === 'USD' ? '$' : item.currency;
                const unitPrice = item.price || 0;
                const quantity = item.quantity || 1;
                const itemTotal = (unitPrice * quantity).toFixed(2);
                const unitPriceFormatted = unitPrice.toFixed(2);

                itemEl.innerHTML = `
                    ${item.imageUrl 
                        ? `<img class="lv-cart-item-image" src="${item.imageUrl}" alt="${item.title}" />`
                        : `<div class="lv-cart-item-image"></div>`}
                    <div class="lv-cart-item-details">
                        <h3 class="lv-cart-item-title">${item.title}</h3>
                        ${item.subtitle ? `<p class="lv-cart-item-subtitle">${item.subtitle}</p>` : ''}
                        <p class="lv-cart-item-vendor">By ${item.vendor || 'Unknown vendor'}</p>
                        <div style="margin: 8px 0; font-size: 13px; color: var(--lv-text-muted);">
                            ${currency}${unitPriceFormatted} each × ${quantity} = ${currency}${itemTotal}
                        </div>
                        <div class="lv-cart-item-actions">
                            <button class="lv-qty-btn" onclick="updateQuantity('${item.id}', ${quantity - 1})">−</button>
                            <span class="lv-qty-display">${quantity}</span>
                            <button class="lv-qty-btn" onclick="updateQuantity('${item.id}', ${quantity + 1})">+</button>
                            <button class="lv-remove-btn" onclick="removeItem('${item.id}')">Remove</button>
                        </div>
                    </div>
                    <div class="lv-cart-item-price">
                        <div style="font-size: 18px; font-weight: 700;">${currency}${itemTotal}</div>
                        <div style="font-size: 12px; color: var(--lv-text-muted);">Total</div>
                    </div>
                `;

                cartItemsList.appendChild(itemEl);
            });

            updateSummary();
        }

        // Update order summary
        function updateSummary() {
            const total = cart.getCartTotal();
            document.getElementById('subtotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }

        // Update item quantity
        async function updateQuantity(productId, quantity) {
            await cart.updateQuantity(productId, quantity);
            renderCart();
        }

        // Remove item from cart
        async function removeItem(productId) {
            if (confirm('Remove this item from your cart?')) {
                await cart.removeFromCart(productId);
                renderCart();
            }
        }

        // Listen for cart updates
        window.addEventListener('cartUpdated', () => {
            console.log('Cart updated event received, rendering cart');
            renderCart();
        });

        // Initial render - wait for cart to load from Firestore
        // Cart loads via auth state change in cart.js, which dispatches cartUpdated
        // But also try to render after a short delay to ensure cart is loaded
        let renderAttempts = 0;
        const maxAttempts = 5;
        
        function attemptRender() {
            renderAttempts++;
            const items = cart.getCartItems();
            console.log('Attempting to render cart, items:', items.length);
            
            if (items.length > 0 || renderAttempts >= maxAttempts) {
                renderCart();
            } else {
                // Try again after a short delay
                setTimeout(attemptRender, 300);
            }
        }
        
        // Start attempting to render after cart initialization
        setTimeout(attemptRender, 500);

        // Proceed to checkout (creates order without Stripe for testing)
        window.proceedToCheckout = async function() {
            const user = auth.currentUser;
            if (!user) {
                alert('Please sign in to checkout');
                window.location.href = 'login.html';
                return;
            }

            const items = cart.getCartItems();
            if (items.length === 0) {
                alert('Your cart is empty');
                return;
            }

            // Confirm checkout
            if (!confirm(`Proceed with checkout for ${items.length} item(s)?`)) {
                return;
            }

            const checkoutBtn = document.getElementById('checkoutBtn');
            const originalText = checkoutBtn.textContent;
            checkoutBtn.disabled = true;
            checkoutBtn.textContent = 'Processing...';

            try {
                // Group items by vendor
                const ordersByVendor = {};
                let totalAmount = 0;

                items.forEach(item => {
                    const vendorUid = item.vendorUid || item.vendorId;
                    if (!vendorUid) {
                        console.warn('Item missing vendorUid:', item);
                        return;
                    }

                    if (!ordersByVendor[vendorUid]) {
                        ordersByVendor[vendorUid] = {
                            vendorId: vendorUid,
                            vendorName: item.vendor || 'Store',
                            items: [],
                            total: 0
                        };
                    }

                    const itemTotal = (item.price || 0) * (item.quantity || 1);
                    ordersByVendor[vendorUid].items.push({
                        productId: item.id,
                        title: item.title,
                        subtitle: item.subtitle,
                        price: item.price,
                        quantity: item.quantity || 1,
                        imageUrl: item.imageUrl
                    });
                    ordersByVendor[vendorUid].total += itemTotal;
                    totalAmount += itemTotal;
                });

                // Get buyer's shipping address from buyer profile
                let shippingAddress = null;
                try {
                    const buyerDoc = await db.collection('buyers').doc(user.uid).get();
                    if (buyerDoc.exists) {
                        const buyerData = buyerDoc.data();
                        if (buyerData.shippingAddress) {
                            shippingAddress = {
                                name: buyerData.shippingAddress.name || '',
                                street: buyerData.shippingAddress.street || '',
                                city: buyerData.shippingAddress.city || '',
                                state: buyerData.shippingAddress.state || '',
                                zip: buyerData.shippingAddress.zip || '',
                                country: buyerData.shippingAddress.country || 'US',
                                phone: buyerData.shippingAddress.phone || ''
                            };
                        }
                    }
                } catch (e) {
                    console.warn('Could not load buyer shipping address:', e);
                }

                // Create an order for each vendor
                const orderPromises = Object.values(ordersByVendor).map(async (vendorOrder) => {
                    const orderData = {
                        buyerId: user.uid,
                        buyerName: user.displayName || user.email?.split('@')[0] || 'Buyer',
                        buyerEmail: user.email || '',
                        vendorId: vendorOrder.vendorId,
                        vendorName: vendorOrder.vendorName,
                        items: vendorOrder.items,
                        itemsCount: vendorOrder.items.length,
                        total: vendorOrder.total,
                        currency: 'USD',
                        paymentStatus: 'paid', // For testing without Stripe
                        fulfillmentStatus: 'processing',
                        shippingAddress: shippingAddress, // Store address directly on order
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    console.log('Creating order:', orderData);
                    const orderRef = await db.collection('orders').add(orderData);
                    console.log('Order created with ID:', orderRef.id);
                    return orderRef;
                });

                const orderIds = await Promise.all(orderPromises);
                console.log('Orders created successfully:', orderIds);

                // Clear cart after successful checkout
                await cart.clearCart();

                alert(`Order placed successfully! ${orderIds.length} order(s) created. You can view them in your Order History.`);
                window.location.href = 'buyer-dashboard.html';
            } catch (error) {
                console.error('Checkout error:', error);
                console.error('Error details:', error.message, error.code, error.stack);
                alert(`Failed to place order: ${error.message}\n\nCheck the browser console (F12) for more details.`);
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = originalText;
            }
        };
    </script>
</body>
</html>
