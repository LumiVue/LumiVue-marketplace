<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>LumiVue Storefront</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />

    <style>
        :root {
            --lv-bg: #f4f1eb;
            --lv-surface: #ffffff;
            --lv-border: #ddd3c6;
            --lv-border-strong: #ccc0b1;
            --lv-text: #2c1e19;
            --lv-text-muted: #7a6a5c;
            --lv-accent: #c98a5a;
            --lv-accent-soft: #fbede1;
            --lv-radius-lg: 18px;
            --lv-shadow-soft: 0 30px 80px rgba(15, 23, 42, 0.22);
            --lv-hero-latte: #f1ddc2;
        }

        * {
            box-sizing: border-box;
        }

        /* Darker latte background around everything */
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #e3ceb2;
            color: var(--lv-text);
        }

        .page {
            max-width: 1120px;
            margin: 0 auto 64px;
            padding: 0 24px;
        }

        /***** TOP NAV â€“ STAYS AT VERY TOP ******/
        .site-nav {
            height: 72px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            background: #f7f3eb;
            position: sticky;
            top: 0;
            z-index: 40;
            box-shadow: 0 10px 30px rgba(15,23,42,0.08);
        }

        .site-nav-inner {
            width: 100%;
            max-width: 1120px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 18px;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .nav-logo-circle {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: #d8b58b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #2c1e19;
            text-transform: uppercase;
        }

        .nav-brand-text {
            font-size: 13px;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--lv-text);
        }

        .nav-tabs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
        }

        .nav-tab-link {
            padding: 6px 14px;
            border-radius: 999px;
            border: none;
            background: #efe1cf;
            font-size: 11px;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: #3b2719;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            white-space: nowrap;
            text-decoration: none;
        }

            .nav-tab-link:hover {
                background: #e5d3be;
            }

        .nav-right {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            white-space: nowrap;
            min-width: 80px;
        }

        .nav-avatar {
            width: 30px;
            height: 30px;
            border-radius: 999px;
            background: #d8b58b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #2c1e19;
            text-transform: uppercase;
        }

        @media (max-width: 900px) {
            .nav-tabs {
                gap: 6px;
            }

            .nav-tab-link {
                padding: 4px 10px;
                font-size: 10px;
            }
        }

        @media (max-width: 720px) {
            .site-nav-inner {
                padding: 0 12px;
                gap: 8px;
            }

            .nav-tabs {
                display: none;
            }
        }

        /***** FULL-WIDTH HERO VIDEO UNDER NAV ******/
        .store-hero {
            width: 100%;
            margin: 0;
            border-radius: 0;
            overflow: hidden;
            position: relative;
            height: 420px;
            background: #e8d4b8;
            border: none;
        }

        .store-hero-media {
            position: absolute;
            inset: 0;
            overflow: hidden;
        }

        .store-hero-video,
        .store-hero-img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /***** SECTION HEADINGS *****/
        .section-heading {
            margin-top: 40px;
            margin-bottom: 18px;
            font-size: 16px;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: var(--lv-text-muted);
        }

        /***** PRODUCT GRID *****/
        .featured-section {
            margin-top: 12px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 18px;
        }

        .product-card {
            border-radius: 18px;
            border: 1px solid var(--lv-border);
            background: #fffdfa;
            box-shadow: 0 22px 55px rgba(15,23,42,0.18);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease;
        }

            .product-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 28px 65px rgba(15,23,42,0.22);
                border-color: rgba(201,138,90,0.7);
            }

            .product-card.placeholder:hover {
                transform: none;
                box-shadow: 0 22px 55px rgba(15,23,42,0.18);
                border-color: var(--lv-border);
            }

        .product-img-wrap {
            position: relative;
            padding-top: 100%;
            background: radial-gradient(circle at top left, #f5e1c7, #f7eee3);
            overflow: hidden;
        }

        .product-img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-placeholder-label {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: rgba(60, 38, 22, 0.65);
            text-align: center;
            padding: 0 12px;
        }

        .product-body {
            padding: 10px 12px 11px;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .product-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--lv-text);
        }

        .product-sub {
            font-size: 11px;
            color: var(--lv-text-muted);
        }

        .product-footer {
            margin-top: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
        }

        .product-price {
            font-weight: 600;
            color: var(--lv-text);
        }

        .product-chip-row {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            font-size: 9px;
            color: var(--lv-text-muted);
        }

        .product-chip {
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid var(--lv-border-strong);
            background: #fff;
        }

        .status-message {
            font-size: 12px;
            color: var(--lv-text-muted);
            margin-top: 16px;
        }

        @media (max-width: 900px) {
            .product-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        @media (max-width: 720px) {
            .product-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        /***** STORE FEATURES SECTION *****/
        .store-features {
            margin-top: 56px;
            margin-bottom: 24px;
        }

        .store-features-subtitle {
            font-size: 13px;
            color: var(--lv-text-muted);
            margin-top: -6px;
            margin-bottom: 22px;
        }

        .feature-card {
            background: var(--lv-surface);
            border-radius: 20px;
            border: 1px solid var(--lv-border);
            box-shadow: 0 18px 50px rgba(15,23,42,0.14);
            padding: 18px 18px 20px;
            margin-bottom: 18px;
        }

        .feature-card-title {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: var(--lv-text);
            margin-bottom: 6px;
        }

        .feature-card-body {
            font-size: 13px;
            line-height: 1.6;
            color: var(--lv-text-muted);
        }

        .feature-tag-row {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .feature-tag {
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--lv-border-strong);
            background: #fbf4ea;
            font-size: 11px;
            color: var(--lv-text);
            cursor: pointer;
        }

        .feature-link {
            display: inline-block;
            margin-top: 10px;
            font-size: 12px;
            text-decoration: none;
            color: var(--lv-text);
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid var(--lv-border-strong);
            background: #f5e5d1;
        }

            .feature-link:hover {
                background: #efd6b5;
            }
    </style>
</head>

<body>
    <!-- TOP NAV ALWAYS AT TOP -->
    <nav class="site-nav">
        <div class="site-nav-inner">
            <div class="nav-left">
                <div class="nav-logo-circle">LV</div>
                <div class="nav-brand-text">LUMIVUE</div>
            </div>

            <div class="nav-tabs">
                <a href="#" class="nav-tab-link" id="navCategoriesLink">Categories</a>
                <a href="#" class="nav-tab-link" id="navBrandStoryLink">Brand Story</a>
                <a href="#" class="nav-tab-link" id="navPoliciesLink">Policies</a>
                <a href="#" class="nav-tab-link" id="navIngredientsLink">Ingredient Glossary</a>
                <a href="#" class="nav-tab-link" id="navReviewsLink">Reviews</a>
                <a href="#" class="nav-tab-link" id="navFaqLink">FAQ</a>
            </div>

            <div class="nav-right">
                <div class="nav-avatar" id="navAvatar">LV</div>
            </div>
        </div>
    </nav>

    <!-- FULL-WIDTH HERO VIDEO / IMAGE -->
    <section class="store-hero" id="videoSection">
        <div class="store-hero-media">
            <video id="storeBannerVideo"
                   class="store-hero-video"
                   muted
                   loop
                   playsinline
                   autoplay
                   style="display:none;"></video>
            <img id="storeBannerImg" class="store-hero-img" alt="" style="display:none;" />
        </div>
    </section>

    <div class="page">
        <!-- FEATURED PRODUCTS HEADING -->
        <h2 class="section-heading">Featured Products</h2>

        <!-- PRODUCT GRID -->
        <section class="featured-section">
            <div class="product-grid" id="productGrid"></div>
            <div class="status-message" id="productsStatus"></div>
        </section>

        <!-- STORE FEATURES SECTION -->
        <section class="store-features" id="storeFeatures">
            <h2 class="section-heading">Vendor Store Features</h2>
            <div class="store-features-subtitle">
                Everything about this storefront in one place â€” story, categories, policies, ingredients, reviews, and answers.
            </div>

            <!-- BRAND STORY CARD -->
            <article class="feature-card" id="brandStoryCard">
                <div class="feature-card-title">Brand Story</div>
                <div class="feature-card-body" id="brandStoryText">
                    Brand story will appear here after the creator saves it in Edit Store.
                </div>
            </article>

            <!-- CATEGORIES CARD -->
            <article class="feature-card" id="categoriesCard">
                <div class="feature-card-title">Categories</div>
                <div class="feature-card-body">
                    Shop the collections this creator offers. Categories help buyers quickly find what fits their skin, mood, or routine.
                    <div class="feature-tag-row" id="categoriesChips"></div>
                </div>
            </article>

            <!-- POLICIES CARD -->
            <article class="feature-card" id="policiesCard">
                <div class="feature-card-title">Policies</div>
                <div class="feature-card-body" id="policiesText">
                    Shipping timelines, returns, exchanges, and processing times will appear here once the creator adds them.
                </div>
            </article>

            <!-- INGREDIENT GLOSSARY CARD -->
            <article class="feature-card" id="ingredientsCard">
                <div class="feature-card-title">Ingredient Glossary</div>
                <div class="feature-card-body" id="ingredientGlossaryText">
                    Hero ingredients, where they come from, and why they were chosen will appear here after the creator adds them in Edit Store.
                </div>
            </article>

            <!-- REVIEWS CARD -->
            <article class="feature-card" id="reviewsCard">
                <div class="feature-card-title">Reviews</div>
                <div class="feature-card-body">
                    Read what other buyers are saying about this store and its products. A highlighted testimonial can be featured here.
                </div>
            </article>

            <!-- FAQ CARD -->
            <article class="feature-card" id="faqCard">
                <div class="feature-card-title">FAQ</div>
                <div class="feature-card-body" id="faqText">
                    Common questions and answers from the creator will appear here â€” everything buyers want to know before they check out.
                </div>
            </article>
        </section>
    </div>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAMmOyBqyPr5KoIzqnItE4sH1lb83iQAo8",
            authDomain: "lumivue-c8fdf.firebaseapp.com",
            projectId: "lumivue-c8fdf",
            storageBucket: "lumivue-c8fdf.firebasestorage.app",
            messagingSenderId: "120420036736",
            appId: "1:120420036736:web:0fbbc98b02ea54840d3665"
        };

        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
    </script>
    
    <!-- FORCE STORE TO ALWAYS LOAD CORRECT VENDOR -->
    <script>
        auth.onAuthStateChanged(user => {
            if (!user) return;

            const params = new URLSearchParams(window.location.search);
            const urlUid = params.get("uid");

            // Redirect if the UID in the URL is missing or wrong
            if (!urlUid || urlUid !== user.uid) {
                window.location.replace(`store.html?uid=${user.uid}`);
            }
        });
    </script>

    <!-- STORE LOGIC -->
    <script>
        const PLACEHOLDER_MIN = 20;

        const bannerImgEl = document.getElementById("storeBannerImg");
        const bannerVideoEl = document.getElementById("storeBannerVideo");
        const productGridEl = document.getElementById("productGrid");
        const productsStatusEl = document.getElementById("productsStatus");
        const navAvatar = document.getElementById("navAvatar");

        const navCategoriesLink = document.getElementById("navCategoriesLink");
        const navBrandStoryLink = document.getElementById("navBrandStoryLink");
        const navPoliciesLink = document.getElementById("navPoliciesLink");
        const navIngredientsLink = document.getElementById("navIngredientsLink");
        const navReviewsLink = document.getElementById("navReviewsLink");
        const navFaqLink = document.getElementById("navFaqLink");

        const brandStoryTextEl = document.getElementById("brandStoryText");
        const categoriesChipsEl = document.getElementById("categoriesChips");
        const policiesTextEl = document.getElementById("policiesText");
        const ingredientGlossaryTextEl = document.getElementById("ingredientGlossaryText");
        const faqTextEl = document.getElementById("faqText");
        const reviewsPageLink = document.getElementById("reviewsPageLink");

        let currentStoreUid = null;

        function buildPlaceholderCard() {
            const card = document.createElement("article");
            card.className = "product-card placeholder";

            const imgWrap = document.createElement("div");
            imgWrap.className = "product-img-wrap";

            const label = document.createElement("div");
            label.className = "product-placeholder-label";
            label.textContent = "No products yet. Create your first product in create-listing.";

            imgWrap.appendChild(label);

            const body = document.createElement("div");
            body.className = "product-body";

            const nameEl = document.createElement("div");
            nameEl.className = "product-name";
            nameEl.textContent = "Create your first product";

            const subEl = document.createElement("div");
            subEl.className = "product-sub";
            subEl.textContent = "Products you create will appear here automatically.";

            const footer = document.createElement("div");
            footer.className = "product-footer";

            const priceEl = document.createElement("div");
            priceEl.className = "product-price";
            priceEl.textContent = "";

            footer.appendChild(priceEl);
            body.appendChild(nameEl);
            body.appendChild(subEl);
            body.appendChild(footer);

            card.appendChild(imgWrap);
            card.appendChild(body);

            return card;
        }

        function renderPlaceholders(count) {
            for (let i = 0; i < count; i++) {
                productGridEl.appendChild(buildPlaceholderCard());
            }
        }

        function setupNavScroll() {
            function scrollToCard(id) {
                const el = document.getElementById(id);
                if (el) {
                    el.scrollIntoView({ behavior: "smooth", block: "start" });
                }
            }

            if (navCategoriesLink) {
                navCategoriesLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    scrollToCard("categoriesCard");
                });
            }
            if (navBrandStoryLink) {
                navBrandStoryLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    scrollToCard("brandStoryCard");
                });
            }
            if (navPoliciesLink) {
                navPoliciesLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    scrollToCard("policiesCard");
                });
            }
            if (navIngredientsLink) {
                navIngredientsLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    scrollToCard("ingredientsCard");
                });
            }
            if (navReviewsLink) {
                navReviewsLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    scrollToCard("reviewsCard");
                });
            }
            if (navFaqLink) {
                navFaqLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    scrollToCard("faqCard");
                });
            }
        }

        function wireLinksForUid(uid) {
            currentStoreUid = uid;
            if (reviewsPageLink) {
                reviewsPageLink.href = "reviews.html?uid=" + encodeURIComponent(uid);
            }
        }

        async function loadStoreProfile(uid, currentUser) {
            try {
                const profileRef = db
                    .collection("stores")
                    .doc(uid)
                    .collection("profile")
                    .doc("main");
                const profileSnap = await profileRef.get();

                let profileData = profileSnap.exists ? profileSnap.data() : null;

                let creatorData = null;
                try {
                    const creatorSnap = await db.collection("creators").doc(uid).get();
                    if (creatorSnap.exists) creatorData = creatorSnap.data();
                } catch (e) {
                    console.warn("Creator doc load failed (ok):", e);
                }

                const data = Object.assign({}, creatorData || {}, profileData || {});

                const storeName = data.storeName || data.brandName || null;
                setAvatarInitials(storeName, currentUser);

                const videoUrl = data.storeVideoUrl;
                const bannerUrl =
                    data.bannerImageUrl ||
                    data.storeLogoUrl ||
                    data.bannerUrl ||
                    data.logoUrl;

                if (videoUrl && bannerVideoEl) {
                    bannerVideoEl.src = videoUrl;
                    bannerVideoEl.style.display = "block";
                    if (bannerImgEl) bannerImgEl.style.display = "none";

                    // Try to autoplay muted (allowed by browsers)
                    bannerVideoEl.play().catch(() => { });

                    // ðŸ”Š Allow sound when buyer clicks the hero video
                    bannerVideoEl.addEventListener("click", () => {
                        bannerVideoEl.muted = false;
                        bannerVideoEl.play().catch(() => { });
                    });
                } else if (bannerUrl && bannerImgEl) {
                    bannerImgEl.src = bannerUrl;
                    bannerImgEl.style.display = "block";
                    if (bannerVideoEl) bannerVideoEl.style.display = "none";
                } else {
                    if (bannerVideoEl) bannerVideoEl.style.display = "none";
                    if (bannerImgEl) bannerImgEl.style.display = "none";
                }

                if (brandStoryTextEl) {
                    brandStoryTextEl.textContent =
                        data.brandStory ||
                        "Brand story will appear here after the creator saves it in Edit Store.";
                }

                const policiesSummary = buildPoliciesSummary(data.policies);
                if (policiesTextEl) {
                    policiesTextEl.textContent =
                        policiesSummary ||
                        "Shipping timelines, return windows, and order adjustments appear here exactly as defined by the vendor.";
                }

                if (ingredientGlossaryTextEl) {
                    ingredientGlossaryTextEl.textContent =
                        data.ingredientGlossary ||
                        "Hero ingredients and short explanations will appear here once the creator adds them.";
                }

                if (faqTextEl) {
                    faqTextEl.textContent =
                        data.faqText ||
                        "Frequently asked questions and answers will appear here once the creator saves them in Edit Store.";
                }
            } catch (err) {
                console.error("Profile error:", err);
            }
        }

        async function loadStoreProducts(uid) {
            try {
                productGridEl.innerHTML = "";
                productsStatusEl.textContent = "Loading products...";

                console.log(`Querying products for vendor: ${uid}`);

                // Query THIS VENDOR'S active products - FIXED: use vendorUid not vendorId
                const listingsRef = db.collection("listings");
                const q = listingsRef
                    .where("vendorUid", "==", uid)
                    .where("status", "==", "active")
                    .orderBy("createdAt", "desc");
                
                const snapshot = await q.get();

                console.log(`Found ${snapshot.size} active products for vendor ${uid}`);

                if (snapshot.empty) {
                    productsStatusEl.textContent = "No products available yet.";
                    renderPlaceholders(3);
                    return;
                }

                productsStatusEl.textContent = "";

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log(`Product: ${doc.id}`, data);

                    const card = document.createElement("article");
                    card.className = "product-card";

                    const imgWrap = document.createElement("div");
                    imgWrap.className = "product-img-wrap";

                    if (data.imageUrl) {
                        const img = document.createElement("img");
                        img.className = "product-img";
                        img.src = data.imageUrl;
                        img.alt = data.title || "Product";
                        imgWrap.appendChild(img);
                    } else {
                        const label = document.createElement("div");
                        label.className = "product-placeholder-label";
                        label.textContent = "No image";
                        imgWrap.appendChild(label);
                    }

                    const body = document.createElement("div");
                    body.className = "product-body";

                    const nameEl = document.createElement("div");
                    nameEl.className = "product-name";
                    nameEl.textContent = data.title || "Untitled Product";

                    const subEl = document.createElement("div");
                    subEl.className = "product-sub";
                    subEl.textContent = data.subtitle || "";

                    const footer = document.createElement("div");
                    footer.className = "product-footer";

                    const priceEl = document.createElement("div");
                    priceEl.className = "product-price";
                    const price = data.priceNumber || parseFloat(data.price) || 0;
                    const currency = data.currency === "USD" ? "$" : data.currency || "$";
                    priceEl.textContent = `${currency}${price.toFixed(2)}`;

                    const chipRow = document.createElement("div");
                    chipRow.className = "product-chip-row";

                    // Add vendor/type chip
                    if (data.vendor || data.type) {
                        const chip = document.createElement("span");
                        chip.className = "product-chip";
                        chip.textContent = [data.vendor, data.type].filter(Boolean).join(" Â· ");
                        chipRow.appendChild(chip);
                    }

                    footer.appendChild(priceEl);
                    footer.appendChild(chipRow);

                    body.appendChild(nameEl);
                    if (subEl.textContent) body.appendChild(subEl);
                    body.appendChild(footer);

                    card.appendChild(imgWrap);
                    card.appendChild(body);

                    // Click to view product details
                    card.addEventListener("click", () => {
                        window.location.href = `product.html?id=${encodeURIComponent(doc.id)}`;
                    });

                    productGridEl.appendChild(card);
                });

                console.log("Products loaded successfully!");
            } catch (err) {
                console.error("Error loading products:", err);
                console.error("Error details:", err.code, err.message);
                productsStatusEl.textContent = `Error loading products: ${err.message}`;
                productGridEl.innerHTML = "";
                renderPlaceholders(1);
            }
        }

        async function loadStoreCategories(uid) {
            if (!categoriesChipsEl) return;

            categoriesChipsEl.innerHTML = "";
            const loading = document.createElement("span");
            loading.className = "feature-tag";
            loading.textContent = "Loadingâ€¦";
            categoriesChipsEl.appendChild(loading);

            try {
                const colRef = db.collection("stores").doc(uid).collection("categories");
                const snap = await colRef.get();

                categoriesChipsEl.innerHTML = "";

                if (snap.empty) {
                    const chip = document.createElement("span");
                    chip.className = "feature-tag";
                    chip.textContent = "No categories added yet.";
                    categoriesChipsEl.appendChild(chip);
                    return;
                }

                snap.forEach((docSnap) => {
                    const data = docSnap.data();
                    const name = data.name || "Category";

                    const chip = document.createElement("button");
                    chip.type = "button";
                    chip.className = "feature-tag";
                    chip.textContent = name;

                    // WHEN BUYER CLICKS A CATEGORY â†’ GO TO product.html WITH UID + CATEGORY
                    chip.addEventListener("click", () => {
                        if (!currentStoreUid) return;
                        const url =
                            "product.html?uid=" +
                            encodeURIComponent(currentStoreUid) +
                            "&category=" +
                            encodeURIComponent(name);
                        window.location.href = url;
                    });

                    categoriesChipsEl.appendChild(chip);
                });
            } catch (err) {
                console.error("Error loading categories", err);
                categoriesChipsEl.innerHTML = "";
                const chip = document.createElement("span");
                chip.className = "feature-tag";
                chip.textContent = "Could not load categories.";
                categoriesChipsEl.appendChild(chip);
            }
        }

        function bootstrapStore() {
            setupNavScroll();

            const urlUid = getStoreUidFromUrl();

            if (urlUid) {
                wireLinksForUid(urlUid);
                loadStoreProfile(urlUid, null);
                loadStoreProducts(urlUid);
                loadStoreCategories(urlUid);
            } else {
                auth.onAuthStateChanged((user) => {
                    if (!user) {
                        productGridEl.innerHTML = "";
                        renderPlaceholders(PLACEHOLDER_MIN);
                        productsStatusEl.textContent =
                            "Store not specified in URL. Sign in and visit your store link.";
                        return;
                    }
                    const uid = user.uid;
                    wireLinksForUid(uid);
                    loadStoreProfile(uid, user);
                    loadStoreProducts(uid);
                    loadStoreCategories(uid);
                });
            }
        }

        function buildPoliciesSummary(policies) {
            if (!policies) return "";
            const parts = [];

            if (policies.processingTime) {
                parts.push(`Processing: ${policies.processingTime}`);
            }
            if (policies.shippingRegions) {
                parts.push(`Ships to: ${policies.shippingRegions}`);
            }

            if (policies.returnsAccepted) {
                let label = "";
                if (policies.returnsAccepted === "yes") {
                    label = "Returns accepted";
                } else if (policies.returnsAccepted === "exchange-only") {
                    label = "Exchange only";
                } else if (policies.returnsAccepted === "final-sale") {
                    label = "All sales final";
                } else {
                    label = policies.returnsAccepted;
                }
                if (policies.returnWindow) {
                    label += ` â€“ ${policies.returnWindow}-day window`;
                }
                parts.push(label);
            }

            if (policies.nonReturnableItems) {
                parts.push(`Non-returnable: ${policies.nonReturnableItems}`);
            }

            return parts.join(" â€¢ ");
        }

        function getStoreUidFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get("uid") || params.get("creator") || params.get("store");
        }

        function setAvatarInitials(storeName, user) {
            let initials = "LV";
            if (storeName) {
                const parts = storeName.trim().split(/\s+/);
                if (parts.length === 1) {
                    initials = parts[0].slice(0, 2).toUpperCase();
                } else {
                    initials =
                        (parts[0][0] || "L").toUpperCase() +
                        (parts[1][0] || "V").toUpperCase();
                }
            } else if (user && user.email) {
                initials = (user.email[0] || "L").toUpperCase();
            }
            navAvatar.textContent = initials;
        }

        const DEMO_PRODUCTS = [];

        bootstrapStore();
    </script>
</body>
</html>

