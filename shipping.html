<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LumiVue · Shipping, Orders & Sales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared LumiVue theme -->
  <link rel="stylesheet" href="styles.css" />

  <style>
    :root {
      /* LumiVue latte / espresso system same as create-listing */
      --lv-bg: #f4f1eb;
      --lv-surface: #ffffff;
      --lv-border: #e6d7c6;
      --lv-border-strong: #d9c6b3;
      --lv-text: #2c1e19;          /* espresso */
      --lv-text-muted: #7a6a5c;
      --lv-pill: #e3ceb2;          /* beige pill */
      --lv-pill-border: #c9a07a;   /* caramel outline */
      --lv-accent-soft: #fbf3e7;
      --lv-shadow-soft: 0 24px 60px rgba(15,23,42,.08);
      --lv-radius-lg: 14px;
      --lv-radius-md: 10px;

      --lv-danger: #c15b4b;
    }

    body{
      margin:0;
      background: var(--lv-bg);
      color: var(--lv-text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Remove all hover pop-ups, transforms, and transitions */
    *:hover,
    *:focus,
    *:active {
      transition: none !important;
      transform: none !important;
      box-shadow: none !important;
      filter: none !important;
    }

    /* =======================
       LUMIVUE SIGNATURE TOP BAR
       ======================= */
    .lv-topbar{
      background: #f7f1e8;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .lv-topbar-inner{
      max-width: 1180px;
      margin: 0 auto;
      padding: 10px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }
    .lv-brand{
      display:flex;
      align-items:center;
      gap: 10px;
      text-decoration:none;
      color: var(--lv-text);
    }
    .lv-bubble{
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: var(--lv-bubble-bg);
      border: 1px solid var(--lv-border-strong);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      letter-spacing: .2px;
      font-size: 12px;
      flex: 0 0 auto;
    }
    .lv-wordmark{
      font-weight: 950;
      letter-spacing: .45em;
      font-size: 13px;
      text-transform: uppercase;
      line-height: 1;
    }

    .lv-nav{
      display:flex;
      align-items:center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .lv-link{
      text-decoration:none;
      color: var(--lv-text-muted);
      font-weight: 800;
      font-size: 13px;
      letter-spacing: .12px;
      padding: 8px 8px;
      border-radius: 10px;
    }
    .lv-link.active{
      color: var(--lv-text);
      text-decoration: underline;
      text-underline-offset: 6px;
      text-decoration-thickness: 2px;
    }

    .lv-right{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    /* === BUTTONS (FLAT / SAME COLOR) === */
    .btn{
      border: 1px solid var(--lv-border-strong);
      background: #e6d8c7;
      color: var(--lv-text);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 13px;
      cursor: pointer;
      box-shadow: none;
      outline: none;
      appearance:none;
      -webkit-appearance:none;
      text-decoration: none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      line-height: 1;
    }

    /* Tabs MUST look like your example: all pills filled, same color, active slightly darker */
    .tab{
      border: 1px solid var(--lv-border-strong);
      background: #e6d8c7;
      color: var(--lv-text);
      padding: 9px 13px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12.5px;
      cursor:pointer;
    }
    .tab.active{
      background: #e6d8c7; /* same color, flat design */
      border-color: var(--lv-border-strong);
    }

    .avatar{
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: var(--lv-button-bg);
      border: 1px solid var(--lv-border-strong);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      font-size: 12px;
      color: var(--lv-text);
      flex: 0 0 auto;
    }

    /* FORCE: no hover popups / no lift */
    .btn, .btn:hover, .btn:focus, .btn:active,
    .tab, .tab:hover, .tab:focus, .tab:active,
    button, button:hover, button:focus, button:active,
    a, a:hover, a:focus, a:active{
      transition: none !important;
      transform: none !important;
      box-shadow: none !important;
      filter: none !important;
      outline: none !important;
    }

    /* =======================
       PAGE PANEL
       ======================= */
    .wrap{
      max-width: 1180px;
      margin: 22px auto 70px;
      padding: 0 18px;
    }

    .panel{
      background: var(--lv-surface);
      border: 1px solid var(--lv-border);
      border-radius: var(--lv-radius-lg);
      box-shadow: var(--lv-shadow-soft);
      overflow:hidden;
    }

    .panelHead{
      padding: 18px 18px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .panelHead h1{
      margin:0;
      font-size: 20px;
      letter-spacing: .18px;
      font-weight: 950;
    }

    .panelHead p{
      margin: 6px 0 0;
      color: var(--lv-text-muted);
      font-size: 13.5px;
      line-height: 1.35;
      max-width: 780px;
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .tabs{
      padding: 0 18px 16px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .divider{
      height:1px;
      background: rgba(0,0,0,.05);
    }

    .section{
      display:none;
      padding: 18px;
    }
    .section.active{ display:block; }

    .secTitle{
      margin:0 0 6px;
      font-size: 15px;
      letter-spacing: .16px;
      font-weight: 950;
    }
    .secSub{
      margin:0 0 14px;
      color: var(--lv-text-muted);
      font-size: 12.8px;
      line-height: 1.35;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .field{
      grid-column: span 12;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .span-6{ grid-column: span 6; }

    .field label{
      font-size: 12.2px;
      color: var(--lv-text-muted);
      font-weight: 950;
      letter-spacing: .1px;
    }

    .field input, .field select, .field textarea{
      border: 1px solid var(--lv-border);
      border-radius: 12px;
      padding: 11px 12px;
      background: var(--lv-accent-soft);
      color: var(--lv-text);
      font-size: 14px;
      outline:none;
    }
    .field textarea{
      min-height: 88px;
      resize: vertical;
      background: #fff;
    }

    @media (max-width: 860px){
      .span-6{ grid-column: span 12; }
      .lv-nav{ display:none; }
    }

    .notice{
      margin-top: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 12px;
      background: #fff;
      color: var(--lv-text-muted);
      font-size: 12.5px;
      line-height: 1.35;
      display:none;
    }

    /* Tables */
    .tableWrap{ overflow:auto; margin-top: 8px; }
    table{ width:100%; border-collapse: collapse; min-width: 980px; }
    th, td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(0,0,0,.05);
      text-align:left;
      font-size: 13.3px;
    }
    th{
      font-size: 12.2px;
      color: var(--lv-text-muted);
      letter-spacing: .12px;
      font-weight: 950;
    }

    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--lv-border);
      background: var(--lv-accent-soft);
      font-size: 12px;
      font-weight: 950;
      letter-spacing: .08px;
    }
    .pill.ok{ background:#fff; }
    .pill.warn{ background: var(--lv-accent-soft); }
    .pill.bad{ background:#fff; color: var(--lv-danger); border-color: rgba(220,38,38,.35); }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4,1fr);
      gap: 12px;
      margin-top: 8px;
    }
    .kpi{
      border: 1px solid var(--lv-border);
      border-radius: 14px;
      background: #fff;
      padding: 14px;
    }
    .kpi span{
      display:block;
      font-size: 12px;
      color: var(--lv-text-muted);
      font-weight: 950;
      margin-bottom: 6px;
      letter-spacing:.08px;
    }
    .kpi strong{
      font-size: 18px;
      letter-spacing: .1px;
      font-weight: 950;
    }
    @media (max-width: 980px){
      .kpis{ grid-template-columns: repeat(2,1fr); }
    }
  </style>
</head>

<body>
  <!-- LUMIVUE SIGNATURE TOP BAR -->
  <header class="lv-topbar">
    <div class="lv-topbar-inner">
      <a class="lv-brand" href="index.html" aria-label="LumiVue Home">
        <div class="lv-bubble">LV</div>
        <div class="lv-wordmark">LUMIVUE</div>
      </a>

      <nav class="lv-nav" aria-label="Vendor navigation">
        <a class="lv-link" href="dashboard.html">Dashboard</a>
        <a class="lv-link" href="listings.html">My products</a>
        <a class="lv-link" href="create-listing.html">Create listing</a>
        <a class="lv-link active" href="shipping.html">Orders</a>
      </nav>

      <div class="lv-right">
        <div class="avatar" id="avatarChip">M</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="panelHead">
        <div>
          <h1>Shipping, Orders & Sales</h1>
          <p>
            Shipping saves to your vendor profile. Orders and Sales pull from your database.
            (Stripe payouts plug in next.)
          </p>
        </div>

        <div class="actions">
          <button class="btn" id="backBtn" type="button">Back</button>
          <button class="btn" id="saveBtn" type="button">Save Shipping</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabShipping" data-tab="shipping" type="button">Shipping</button>
        <button class="tab" id="tabOrders" data-tab="orders" type="button">Orders</button>
        <button class="tab" id="tabSales" data-tab="sales" type="button">Sales</button>
      </div>

      <div class="divider"></div>

      <!-- SHIPPING -->
      <div class="section active" id="shipping">
        <h2 class="secTitle">Shipping & Delivery Promises</h2>
        <p class="secSub">Set defaults applied to your listings. Buyers see these expectations on product pages.</p>

        <div class="grid">
          <div class="field span-6">
            <label for="shipFromCountry">Ships from (Country)</label>
            <select id="shipFromCountry">
              <option value="US">United States</option>
              <option value="CA">Canada</option>
              <option value="MX">Mexico</option>
              <option value="UK">United Kingdom</option>
              <option value="EU">European Union</option>
              <option value="AU">Australia</option>
              <option value="OTHER">Other</option>
            </select>
          </div>

          <div class="field span-6">
            <label for="shipFromRegion">State / Region (optional)</label>
            <input id="shipFromRegion" type="text" placeholder="Arizona" />
          </div>

          <div class="field span-6">
            <label for="processingTime">Typical processing time</label>
            <select id="processingTime">
              <option value="same_day">Same day</option>
              <option value="1_2_bd">1–2 business days</option>
              <option value="2_3_bd">2–3 business days</option>
              <option value="3_5_bd">3–5 business days</option>
              <option value="1_2_weeks">1–2 weeks (made to order)</option>
            </select>
          </div>

          <div class="field span-6">
            <label for="processingNotes">Processing note (optional)</label>
            <input id="processingNotes" type="text" placeholder="Made-to-order items may take longer during holidays." />
          </div>

          <div class="field span-6">
            <label for="domesticDelivery">Typical delivery time (Domestic)</label>
            <input id="domesticDelivery" type="text" placeholder="3–7 business days" />
          </div>

          <div class="field span-6">
            <label for="internationalDelivery">Typical delivery time (International, optional)</label>
            <input id="internationalDelivery" type="text" placeholder="7–21 business days" />
          </div>

          <div class="field">
            <label for="buyerNotes">Buyer note (optional)</label>
            <textarea id="buyerNotes" placeholder="Example: Tracking is provided when available. Delivery times may vary due to carrier delays."></textarea>
          </div>
        </div>

        <div class="notice" id="shipNotice"></div>
      </div>

      <!-- ORDERS -->
      <div class="section" id="orders">
        <h2 class="secTitle">Orders</h2>
        <p class="secSub">Orders appear automatically after checkout is live.</p>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Order</th>
                <th>Date</th>
                <th>Buyer</th>
                <th>Address</th>
                <th>Products</th>
                <th>Items</th>
                <th>Total</th>
                <th>Payment</th>
                <th>Status</th>
                <th>Tracking</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersBody">
              <tr><td colspan="11" style="color:var(--lv-text-muted); padding:18px;">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="notice" id="ordersNotice"></div>
      </div>

      <!-- SALES -->
      <div class="section" id="sales">
        <h2 class="secTitle">Sales</h2>
        <p class="secSub">Totals shown from paid orders. Stripe payouts will plug in next.</p>

        <div class="kpis">
          <div class="kpi"><span>Gross sales</span><strong id="kGross">$0.00</strong></div>
          <div class="kpi"><span>Marketplace fees</span><strong id="kFees">$0.00</strong></div>
          <div class="kpi"><span>Net earnings</span><strong id="kNet">$0.00</strong></div>
          <div class="kpi"><span>Pending payout</span><strong id="kPending">$0.00</strong></div>
        </div>

        <div class="tableWrap" style="margin-top:14px;">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Order</th>
                <th>Gross</th>
                <th>Fees</th>
                <th>Net</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="salesBody">
              <tr><td colspan="6" style="color:var(--lv-text-muted); padding:18px;">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="notice" id="salesNotice"></div>
      </div>
    </section>
  </main>

  <!-- Firebase CDN SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAMmOyBqyPr5KoIzqnItE4sH1lb83iQAo8",
      authDomain: "lumivue-c8fdf.firebaseapp.com",
      projectId: "lumivue-c8fdf",
      storageBucket: "lumivue-c8fdf.firebasestorage.app",
      messagingSenderId: "120420036736",
      appId: "1:120420036736:web:0fbbc98b02ea54840d3665"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    const LOGIN_PAGE = "login.html";

    const $ = (id) => document.getElementById(id);

    function showNotice(id, msg, isError=false){
      const el = $(id);
      el.style.display = "block";
      el.style.color = isError ? "var(--lv-danger)" : "var(--lv-text-muted)";
      el.textContent = msg;
    }

    function money(n){
      const num = Number(n || 0);
      return "$" + num.toFixed(2);
    }

    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, {year:"numeric", month:"short", day:"numeric"});
      }catch(e){ return ""; }
    }

    function pill(label, type){
      const cls = type === "ok" ? "pill ok" : type === "bad" ? "pill bad" : "pill warn";
      return `<span class="${cls}">${label}</span>`;
    }

    function setAvatarFromUser(user){
      const chip = $("avatarChip");
      if(!chip) return;
      const name = (user.displayName || "").trim();
      const email = (user.email || "").trim();
      const pick = (name || email || "M").replace(/[^a-zA-Z0-9]/g, "");
      chip.textContent = (pick[0] || "M").toUpperCase();
    }

    /* ====== TAB WIRING (this is what you said is not working) ====== */
    const tabs = [
      { btn: "tabShipping", sec: "shipping" },
      { btn: "tabOrders",   sec: "orders"   },
      { btn: "tabSales",    sec: "sales"    }
    ];

    function switchTab(sectionId){
      // set sections
      tabs.forEach(t => {
        const b = $(t.btn);
        const s = $(t.sec);
        if(!b || !s) return;
        const on = (t.sec === sectionId);
        b.classList.toggle("active", on);
        s.classList.toggle("active", on);
      });

      // if orders/sales: refresh view (so it feels live)
      if(sectionId === "orders" || sectionId === "sales"){
        if(currentUser) loadOrdersAndSales(currentUser.uid);
      }
    }

    tabs.forEach(t => {
      const b = $(t.btn);
      if(b) b.addEventListener("click", () => switchTab(t.sec));
    });

    /* ====== PAGE BUTTONS (wired) ====== */
    $("backBtn").addEventListener("click", () => {
      try { history.back(); } catch(e) { window.location.href = "dashboard.html"; }
    });

    let currentUser = null;

    auth.onAuthStateChanged(async (user) => {
      currentUser = user;
      
      if(!user){
        // Show login prompt but don't block page access
        console.log('User not logged in - page accessible but features may be limited');
        return;
      }

      /* ======================================================
         ✅ ADDED: VENDOR-ONLY GATE (buyers cannot use this page)
         This page saves to vendor profile, so only creators can proceed.
         ====================================================== */
      try{
        const creatorSnap = await db.collection("creators").doc(user.uid).get();
        if(!creatorSnap.exists){
          alert("This page is for vendors only.");
          window.location.href = "account.html";
          return;
        }
      }catch(e){
        console.error("Vendor check failed:", e);
        alert("Unable to verify vendor access.");
        window.location.href = "account.html";
        return;
      }
      /* ===================== END ADDED GATE ===================== */

      setAvatarFromUser(user);

      // Check for tab parameter in URL and switch tab BEFORE loading data
      const urlParams = new URLSearchParams(window.location.search);
      const tabParam = urlParams.get('tab');
      if (tabParam === 'orders' || tabParam === 'sales') {
        switchTab(tabParam);
      }

      await loadShipping(user.uid);
      // Only load orders/sales if we're on those tabs (or if no tab specified, load anyway)
      if (!tabParam || tabParam === 'orders' || tabParam === 'sales') {
        await loadOrdersAndSales(user.uid);
      }
    });

    $("saveBtn").addEventListener("click", async () => {
      if(!currentUser) return;
      await saveShipping(currentUser.uid);
    });

    /* ====== SHIPPING SAVE/LOAD ====== */
    async function loadShipping(uid){
      try{
        const ref = db.collection("vendors").doc(uid).collection("settings").doc("shipping");
        const snap = await ref.get();

        const data = snap.exists ? snap.data() : {
          shipFromCountry: "US",
          shipFromRegion: "",
          processingTime: "1_2_bd",
          processingNotes: "",
          domesticDelivery: "3–7 business days",
          internationalDelivery: "",
          buyerNotes: ""
        };

        $("shipFromCountry").value = data.shipFromCountry || "US";
        $("shipFromRegion").value = data.shipFromRegion || "";
        $("processingTime").value = data.processingTime || "1_2_bd";
        $("processingNotes").value = data.processingNotes || "";
        $("domesticDelivery").value = data.domesticDelivery || "";
        $("internationalDelivery").value = data.internationalDelivery || "";
        $("buyerNotes").value = data.buyerNotes || "";

        showNotice("shipNotice", snap.exists ? "Shipping loaded." : "Set your shipping defaults, then click Save Shipping.");
      }catch(err){
        showNotice("shipNotice", "Could not load shipping. Check Firestore rules + console.", true);
        console.error(err);
      }
    }

    async function saveShipping(uid){
      const payload = {
        shipFromCountry: $("shipFromCountry").value,
        shipFromRegion: $("shipFromRegion").value.trim(),
        processingTime: $("processingTime").value,
        processingNotes: $("processingNotes").value.trim(),
        domesticDelivery: $("domesticDelivery").value.trim(),
        internationalDelivery: $("internationalDelivery").value.trim(),
        buyerNotes: $("buyerNotes").value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try{
        const ref = db.collection("vendors").doc(uid).collection("settings").doc("shipping");
        await ref.set(payload, { merge:true });
        showNotice("shipNotice", "Saved. Shipping defaults updated.");
      }catch(err){
        showNotice("shipNotice", "Save failed. Check Firestore rules + console.", true);
        console.error(err);
      }
    }

    /* ====== ORDERS + SALES LOAD ====== */
    async function loadOrdersAndSales(uid){
      try{
        const q = await db.collection("orders")
          .where("vendorId", "==", uid)
          .orderBy("createdAt", "desc")
          .limit(200)
          .get();

        const orders = [];
        q.forEach(doc => {
          const d = doc.data() || {};
          orders.push({
            id: doc.id,
            createdAt: d.createdAt?.toDate ? d.createdAt.toDate().toISOString() : (d.createdAt || ""),
            buyerId: d.buyerId || "",
            buyerName: d.buyerName || "",
            buyerEmail: d.buyerEmail || "",
            items: d.items || [],
            itemsCount: d.itemsCount || 0,
            total: Number(d.total || 0),
            paymentStatus: (d.paymentStatus || "unpaid").toLowerCase(),
            fulfillmentStatus: (d.fulfillmentStatus || "processing").toLowerCase(),
            carrier: d.carrier || "",
            trackingNo: d.trackingNo || "",
            // Shipping address is stored directly on order document
            shippingAddress: d.shippingAddress || null
          });
        });

        // Address is stored directly on order document - no need to fetch from buyer profile
        renderOrders(orders);
        renderSales(orders);

      }catch(err){
        console.error(err);
        $("ordersBody").innerHTML = `<tr><td colspan="11" style="color:var(--lv-text-muted); padding:18px;">No orders yet (or rules/schema not ready).</td></tr>`;
        $("salesBody").innerHTML = `<tr><td colspan="6" style="color:var(--lv-text-muted); padding:18px;">No sales yet.</td></tr>`;
        showNotice("ordersNotice", "If checkout isn't live yet, this is normal. When you add Stripe + write orders to Firestore, they'll appear here.", true);
        showNotice("salesNotice", "Sales appear after paid orders exist.", true);
      }
    }

    function renderOrders(list){
      if(!list.length){
        $("ordersBody").innerHTML = `<tr><td colspan="11" style="color:var(--lv-text-muted); padding:18px;">No orders yet.</td></tr>`;
        showNotice("ordersNotice", "Orders will appear once customers purchase your products.");
        return;
      }

      const rows = list.map(o => {
        const buyer = (o.buyerName || "Buyer") + (o.buyerEmail ? `<div style="color:var(--lv-text-muted); font-size:12px; margin-top:3px;">${o.buyerEmail}</div>` : "");

        // Build buyer address - read from order.shippingAddress
        let addressText = "—";
        if (o.shippingAddress && typeof o.shippingAddress === 'object' && o.shippingAddress !== null) {
          const addr = o.shippingAddress;
          const parts = [];
          
          // Add name if available
          if (addr.name) {
            parts.push(addr.name);
          }
          
          // Add street address
          if (addr.street) {
            parts.push(addr.street);
          }
          
          // Add city, state, zip in one line
          const cityStateZip = [addr.city, addr.state, addr.zip].filter(Boolean).join(', ');
          if (cityStateZip) {
            parts.push(cityStateZip);
          }
          
          // Add country if available and not US
          if (addr.country && addr.country !== 'US') {
            parts.push(addr.country);
          }
          
          // Add phone if available
          if (addr.phone) {
            parts.push(addr.phone);
          }
          
          // Join parts with line breaks for readable address display
          addressText = parts.length > 0 ? parts.join('<br>') : "—";
        } else if (typeof o.shippingAddress === 'string' && o.shippingAddress.trim()) {
          // Handle case where address might be stored as a string
          addressText = o.shippingAddress;
        }

        // Build products list
        let productsList = "—";
        if (o.items && Array.isArray(o.items) && o.items.length > 0) {
          productsList = o.items.map(item => {
            const qty = item.quantity || 1;
            return `${item.title || 'Product'}${qty > 1 ? ` (×${qty})` : ''}`;
          }).join('<br>');
        } else if (o.itemsCount > 0) {
          productsList = `${o.itemsCount} item${o.itemsCount !== 1 ? 's' : ''}`;
        }

        const payPill =
          o.paymentStatus === "paid" ? pill("Paid","ok") :
          o.paymentStatus === "refunded" ? pill("Refunded","bad") :
          pill("Unpaid","warn");

        const currentStatus = o.fulfillmentStatus || "processing";

        return `
          <tr id="order-row-${o.id}">
            <td><strong>#${o.id.slice(0,8).toUpperCase()}</strong></td>
            <td>${fmtDate(o.createdAt)}</td>
            <td style="font-size: 12px; line-height: 1.4;">${buyer}</td>
            <td style="font-size: 11px; line-height: 1.4; color:var(--lv-text-muted);">${addressText}</td>
            <td style="font-size: 12px; line-height: 1.4;">${productsList}</td>
            <td>${o.itemsCount || 0}</td>
            <td>${money(o.total)}</td>
            <td>${payPill}</td>
            <td>
              <select id="status-${o.id}" style="padding: 6px 8px; border: 1px solid var(--lv-border); border-radius: 8px; font-size: 12px; background: var(--lv-surface); color: var(--lv-text); min-width: 110px;">
                <option value="processing" ${currentStatus === "processing" ? "selected" : ""}>Processing</option>
                <option value="shipped" ${currentStatus === "shipped" ? "selected" : ""}>Shipped</option>
                <option value="delivered" ${currentStatus === "delivered" ? "selected" : ""}>Delivered</option>
              </select>
            </td>
            <td>
              <input type="text" id="tracking-${o.id}" value="${o.trackingNo || ""}" placeholder="Tracking #" style="padding: 6px 8px; border: 1px solid var(--lv-border); border-radius: 8px; font-size: 12px; background: var(--lv-surface); color: var(--lv-text); min-width: 140px;" />
            </td>
            <td>
              <button onclick="updateOrderStatus('${o.id}')" style="padding: 6px 12px; border: 1px solid var(--lv-border-strong); background: #e6d8c7; color: var(--lv-text); border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer;">Update</button>
            </td>
          </tr>
        `;
      }).join("");

      $("ordersBody").innerHTML = rows;
      showNotice("ordersNotice", `${list.length} order${list.length===1?"":"s"} loaded.`);
    }

    // Update order status and tracking
    async function updateOrderStatus(orderId){
      if(!currentUser) return;

      const statusSelect = document.getElementById(`status-${orderId}`);
      const trackingInput = document.getElementById(`tracking-${orderId}`);

      if(!statusSelect || !trackingInput) {
        console.error('Could not find status or tracking inputs for order', orderId);
        return;
      }

      const newStatus = statusSelect.value;
      const trackingNo = trackingInput.value.trim();

      try {
        const orderRef = db.collection("orders").doc(orderId);
        const updateData = {
          fulfillmentStatus: newStatus,
          trackingNo: trackingNo || "",
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await orderRef.update(updateData);
        showNotice("ordersNotice", "Order updated successfully. Buyer will see the updated status.");
        
        // Refresh orders display
        if(currentUser) await loadOrdersAndSales(currentUser.uid);
      } catch (error) {
        console.error('Error updating order:', error);
        showNotice("ordersNotice", "Failed to update order. Check console.", true);
      }
    }

    // Make updateOrderStatus available globally
    window.updateOrderStatus = updateOrderStatus;

    function renderSales(list){
      if(!list.length){
        $("kGross").textContent = "$0.00";
        $("kFees").textContent = "$0.00";
        $("kNet").textContent = "$0.00";
        $("kPending").textContent = "$0.00";
        $("salesBody").innerHTML = `<tr><td colspan="6" style="color:var(--lv-text-muted); padding:18px;">No sales yet.</td></tr>`;
        showNotice("salesNotice", "Sales will appear once paid orders exist.");
        return;
      }

      const paid = list.filter(o => o.paymentStatus === "paid");
      const gross = paid.reduce((sum,o)=> sum + (o.total||0), 0);

      const feeRate = 0.10;
      const fees = gross * feeRate;
      const net = gross - fees;

      const pending = paid
        .filter(o => o.fulfillmentStatus !== "shipped")
        .reduce((sum,o)=> sum + (o.total||0), 0) * (1 - feeRate);

      $("kGross").textContent = money(gross);
      $("kFees").textContent = money(fees);
      $("kNet").textContent = money(net);
      $("kPending").textContent = money(pending);

      const rows = paid.map(o => {
        const ogross = o.total || 0;
        const ofee = ogross * feeRate;
        const onet = ogross - ofee;
        const status = o.fulfillmentStatus === "shipped" ? pill("Eligible","ok") : pill("Pending","warn");

        return `
          <tr>
            <td>${fmtDate(o.createdAt)}</td>
            <td><strong>#${o.id.slice(0,8).toUpperCase()}</strong></td>
            <td>${money(ogross)}</td>
            <td>${money(ofee)}</td>
            <td>${money(onet)}</td>
            <td>${status}</td>
          </tr>
        `;
      }).join("");

      $("salesBody").innerHTML = rows || `<tr><td colspan="6" style="color:var(--lv-text-muted); padding:18px;">No paid orders yet.</td></tr>`;
      showNotice("salesNotice", "Sales calculated from paid orders. Stripe payouts will plug in next.");
    }
  </script>
</body>
</html>
