<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LumiVue   Vendor Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Global stylesheet -->
  <link rel="stylesheet" href="styles.css" />

  <style>
    :root{
      /* LumiVue latte / espresso system same as create-listing */
      --lv-bg:#f4f1eb;
      --lv-surface:#ffffff;
      --lv-border:#e6d7c6;
      --lv-border-strong:#d9c6b3;
      --lv-text:#2c1e19;          /* espresso */
      --lv-text-muted:#7a6a5c;
      --lv-pill:#e3ceb2;          /* beige pill */
      --lv-pill-border:#c9a07a;   /* caramel outline */
      --lv-accent-soft:#fbf3e7;
      --lv-shadow-soft:0 24px 60px rgba(15,23,42,.08);
      --lv-radius-lg:14px;
      --lv-radius-md:10px;

      --lv-danger:#c15b4b;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: var(--lv-bg);
      color: var(--lv-text);
    }

    .lv-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER   match create-listing */
    .lv-header {
      padding: 12px 24px 6px;
      background: var(--lv-bg);
    }

    .lv-header-inner {
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .lv-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .lv-logo-badge {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(44,30,25,.28);
      background: radial-gradient(circle at 30% 0%, #fdf7ef 0, #e4c6a3 55%, #c79f74 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: .12em;
      color: var(--lv-text);
      text-transform: uppercase;
    }

    .lv-brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .lv-brand-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: .18em;
      text-transform: uppercase;
    }

    .lv-brand-subtitle {
      font-size: 12px;
      color: var(--lv-text-muted);
    }

    .lv-header-right {
      display: flex;
      align-items: center;
      gap: 18px;
    }

    /* TEXT NAV   like create-listing */
    .lv-top-nav {
      display: flex;
      align-items: center;
      gap: 18px;
      font-size: 13px;
    }

    .lv-top-nav a {
      position: relative;
      padding: 2px 0 4px;
      text-decoration: none;
      color: var(--lv-text-muted);
      font-weight: 400;
    }

    .lv-top-nav a.lv-nav-active {
      color: var(--lv-text);
      font-weight: 500;
    }

    .lv-top-nav a.lv-nav-active::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 2px;
      background: var(--lv-text);
      border-radius: 999px;
    }

    /* round M avatar   like screenshot 2 */
    .lv-user-pill {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(44,30,25,.28);
      background: radial-gradient(circle at 30% 0%, #fdf7ef 0, #e4c6a3 55%, #c79f74 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--lv-text);
    }

    .lv-user-pill span {
      letter-spacing: .08em;
    }

    .lv-main-wrap {
      flex: 1;
      padding: 0 24px 32px;
    }

    .lv-main {
      max-width: 1120px;
      margin: 0 auto 40px;
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.1fr);
      gap: 22px;
      align-items: flex-start;
    }

    .lv-page-title-row {
      max-width: 1120px;
      margin: 4px auto 14px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 10px;
    }

    .lv-page-title-block h1 {
      margin: 0 0 4px;
      font-size: 22px;
      letter-spacing: .06em;
      text-transform: uppercase;
    }

    .lv-page-title-block p {
      margin: 0;
      font-size: 13px;
      color: var(--lv-text-muted);
    }

    .lv-page-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* BUTTONS   same beige pills, espresso text */
    .lv-btn {
      border-radius: 999px;
      border: 1px solid var(--lv-border-strong);
      background: #e6d8c7;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--lv-text);   /* espresso text */
    }

    .lv-btn-primary {
      box-shadow: 0 14px 32px rgba(44,30,25,.18);
      font-weight: 500;
    }

    .lv-btn:hover {
      background: #e6d8c7;
    }

    .lv-card,
    .lv-panel {
      background: var(--lv-surface);
      border-radius: var(--lv-radius-lg);
      border: 1px solid var(--lv-border);
      box-shadow: var(--lv-shadow-soft);
      padding: 16px 18px;
    }

    .lv-card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 10px;
    }

    .lv-card-header h2 {
      margin: 0;
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: .12em;
    }

    .lv-card-header span {
      font-size: 12px;
      color: var(--lv-text-muted);
    }

    /* store performance metrics */
    .lv-metrics-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    .lv-metric-card {
      background: #fbf1e3;
      border-radius: var(--lv-radius-md);
      border: 1px solid var(--lv-border-strong);
      padding: 10px 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .lv-metric-label {
      font-size: 11px;
      color: var(--lv-text-muted);
      letter-spacing: .12em;
      text-transform: uppercase;
    }

    .lv-metric-value {
      font-size: 20px;
      font-weight: 600;
    }

    .lv-metric-sub {
      font-size: 11px;
      color: var(--lv-text-muted);
    }

    .lv-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 4px;
    }

    .lv-chip {
      border-radius: 999px;
      border: 1px solid var(--lv-border-strong);
      background: var(--lv-accent-soft);
      font-size: 12px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      color: var(--lv-text);
      cursor: pointer;
    }

    .lv-chip span {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--lv-text-muted);
    }

    .lv-section-label {
      margin: 14px 0 6px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: var(--lv-text-muted);
    }

    .lv-activity-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .lv-activity-item {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--lv-border-strong);
      background: #fbf1e3;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
    }

    .lv-activity-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .lv-activity-main strong {
      font-size: 13px;
    }

    .lv-activity-meta {
      font-size: 11px;
      color: var(--lv-text-muted);
    }

    .lv-activity-tag {
      align-self: flex-start;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(184,112,59,.06);
      border: 1px solid rgba(184,112,59,.4);
      color: var(--lv-text);
      text-transform: uppercase;
      letter-spacing: .12em;
    }

    /* ONBOARDING PANEL (right column) */
    .lv-onboarding-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .lv-onboarding-title {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .12em;
    }

    .lv-status-pill {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--lv-border-strong);
      background: var(--lv-accent-soft);
      color: var(--lv-text);
      white-space: nowrap;
    }

    .lv-onboarding-bar-wrap {
      margin-bottom: 12px;
    }

    .lv-onboarding-bar-shell {
      position: relative;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #f1e4d6;
      overflow: hidden;
      margin-bottom: 6px;
    }

    .lv-onboarding-bar-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg,#c79f74,#aa7a4a);
      transition: width .25s ease-out;
    }

    .lv-onboarding-meta {
      font-size: 11px;
      color: var(--lv-text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .lv-onboarding-meta span {
      white-space: nowrap;
    }

    /* cards grid */
    .lv-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
      margin-top: 6px;
    }

    .lv-card-title {
      font-size: 13px;
      font-weight: 600;
    }

    .lv-card-status {
      font-size: 11px;
      color: var(--lv-text-muted);
      white-space: nowrap;
    }

    .lv-card-body {
      font-size: 12px;
      color: var(--lv-text);
      margin-bottom: 8px;
    }

    .lv-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--lv-text-muted);
    }

    .lv-card-note {
      flex: 1;
    }

    .lv-card-manage {
      border-radius: 999px;
      border: 1px solid var(--lv-pill-border);
      background: var(--lv-pill);
      padding: 5px 11px;
      font-size: 12px;
      cursor: pointer;
      color: var(--lv-text);
      white-space: nowrap;
    }

    .lv-card-manage:hover {
      background: #f0ddc8;
    }

    .lv-footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: var(--lv-text-muted);
    }

    /* Responsive just for this page */
    @media (max-width: 900px) {
      .lv-header-inner {
        flex-direction: column;
        align-items: flex-start;
      }

      .lv-main {
        grid-template-columns: minmax(0, 1fr);
      }

      .lv-page-title-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .lv-metrics-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .lv-metrics-row {
        grid-template-columns: minmax(0, 1fr);
      }

      .lv-main-wrap {
        padding: 0 16px 24px;
      }
    }
  </style>
</head>
<body>
  <div class="lv-shell">
    <!-- Header -->
    <header class="lv-header">
      <div class="lv-header-inner">
        <div class="lv-brand">
          <div class="lv-logo-badge">LV</div>
          <div class="lv-brand-text">
            <div class="lv-brand-title">LUMIVUE</div>
            <div class="lv-brand-subtitle">Creator dashboard   Marketplace studio</div>
          </div>
        </div>

        <div class="lv-header-right">
          <nav class="lv-top-nav">
            <a href="dashboard.html" class="lv-nav-active">Dashboard</a>
            <a href="listings.html">Listings</a>
            <a href="create-listing.html">Create listing</a>
            <a href="store.html">Storefront</a>
            <a href="account-payouts.html">Payouts</a>
            <a href="account-legal.html">Legal</a>
          </nav>

          <div class="lv-user-pill">
            <span>M</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Page title / actions -->
    <div class="lv-main-wrap">
      <div class="lv-page-title-row">
        <div class="lv-page-title-block">
          <h1>Vendor dashboard</h1>
          <p>Track your LumiVue storefront, listings, and revenue at a glance.</p>
        </div>
        <div class="lv-page-actions">
          <button class="lv-btn" onclick="goTo('edit-store.html')">
            Edit store
          </button>
          <button class="lv-btn lv-btn-primary" onclick="goTo('create-listing.html')">
            + New listing
          </button>
        </div>
      </div>

      <!-- Main grid -->
      <main class="lv-main">
        <!-- LEFT COLUMN   performance + quick actions -->
        <section class="lv-card">
          <div class="lv-card-header">
            <h2>Store performance</h2>
            <span>Last 30 days (sample numbers   can connect to data later)</span>
          </div>

          <!-- Metrics -->
          <div class="lv-metrics-row">
            <div class="lv-metric-card">
              <div class="lv-metric-label">Views</div>
              <div class="lv-metric-value" id="metricViews">0</div>
              <div class="lv-metric-sub">Across all active listings</div>
            </div>
            <div class="lv-metric-card">
              <div class="lv-metric-label">Favorites</div>
              <div class="lv-metric-value" id="metricFavorites">0</div>
              <div class="lv-metric-sub">Shoppers saving your products</div>
            </div>
            <div class="lv-metric-card" onclick="goTo('shipping.html?tab=orders')" style="cursor: pointer;">
              <div class="lv-metric-label">Orders</div>
              <div class="lv-metric-value" id="metricOrders">0</div>
              <div class="lv-metric-sub">Completed in this period</div>
            </div>
            <div class="lv-metric-card" onclick="goTo('shipping.html?tab=sales')" style="cursor: pointer;">
              <div class="lv-metric-label">Estimated revenue</div>
              <div class="lv-metric-value" id="metricRevenue">$0</div>
              <div class="lv-metric-sub">Before LumiVue fees</div>
            </div>
          </div>

          <!-- Quick actions -->
          <div class="lv-section-label">Quick actions</div>
          <div class="lv-quick-actions">
            <a href="create-listing.html" class="lv-chip">
              <span>Listing</span>
              Create a new product
            </a>
            <a href="listings.html" class="lv-chip">
              <span>Catalog</span>
              Manage all listings
            </a>
            <a href="edit-store.html" class="lv-chip">
              <span>Storefront</span>
              Update banner &amp; brand story
            </a>
            <a href="account-payouts.html" class="lv-chip">
              <span>Payouts</span>
              Confirm bank &amp; schedule
            </a>
          </div>

          <!-- Recent activity -->
          <div class="lv-section-label">Recent activity</div>
          <ul class="lv-activity-list" id="recentActivityList">
            <li class="lv-activity-item">
              <div class="lv-activity-main">
                <strong>"Cr me de Lumi re" approved</strong>
                <div class="lv-activity-meta">Your new moisturizer listing is now live on LumiVue.</div>
              </div>
              <div class="lv-activity-tag">Listing live</div>
            </li>
            <li class="lv-activity-item">
              <div class="lv-activity-main">
                <strong>3 new favorites</strong>
                <div class="lv-activity-meta">Serum Lumi re   Le Lait Coco   Lumi re Toner</div>
              </div>
              <div class="lv-activity-tag">Engagement</div>
            </li>
            <li class="lv-activity-item">
              <div class="lv-activity-main">
                <strong>Payout queued</strong>
                <div class="lv-activity-meta">Next deposit scheduled based on your payout settings.</div>
              </div>
              <div class="lv-activity-tag">Payout</div>
            </li>
          </ul>
        </section>

        <!-- RIGHT COLUMN   onboarding cards wired to other pages -->
        <aside class="lv-panel">
          <div class="lv-onboarding-header">
            <div class="lv-onboarding-title">Account onboarding</div>
            <div class="lv-status-pill" id="overallStatusPill">Status: Not approved yet</div>
          </div>

          <div class="lv-onboarding-bar-wrap">
            <div class="lv-onboarding-bar-shell">
              <div class="lv-onboarding-bar-fill" id="onboardingBar"></div>
            </div>
            <div class="lv-onboarding-meta">
              <span id="onboardingPercent">0%</span>
              <span>Complete all required sections to activate payouts.</span>
            </div>
          </div>

          <!-- cards -->
          <div class="lv-grid">
            <!-- Legal -->
            <article class="lv-card" onclick="goTo('account-legal.html')">
              <div class="lv-card-header">
                <div class="lv-card-title">Legal business name &amp; contact details</div>
                <div class="lv-card-status" id="status-legal">Not started</div>
              </div>
              <div class="lv-card-body">
                Add your legal business name, primary contact, and full billing address so we can generate invoices and compliance documents.
              </div>
              <div class="lv-card-footer">
                <span class="lv-card-note">Required before payouts can be activated.</span>
                <button type="button"
                        class="lv-card-manage"
                        onclick="goTo('account-legal.html'); event.stopPropagation();">
                  Manage
                </button>
              </div>
            </article>

            <!-- Tax -->
            <article class="lv-card" onclick="goTo('account-tax.html')">
              <div class="lv-card-header">
                <div class="lv-card-title">Tax forms &amp; marketplace agreements</div>
                <div class="lv-card-status" id="status-tax">Not started</div>
              </div>
              <div class="lv-card-body">
                Upload W-9 / W-8 forms, complete ID verification, and confirm LumiVue marketplace agreements for your region.
              </div>
              <div class="lv-card-footer">
                <span class="lv-card-note">Helps keep payouts compliant and secure.</span>
                <button type="button"
                        class="lv-card-manage"
                        onclick="goTo('account-tax.html'); event.stopPropagation();">
                  Manage
                </button>
              </div>
            </article>

            <!-- Bank -->
            <article class="lv-card" onclick="goTo('account-payouts.html')">
              <div class="lv-card-header">
                <div class="lv-card-title">Bank account &amp; payout schedule</div>
                <div class="lv-card-status" id="status-payouts">Not started</div>
              </div>
              <div class="lv-card-body">
                Connect the payout bank account where you want to receive funds, choose a schedule, and review your deposit summary.
              </div>
              <div class="lv-card-footer">
                <span class="lv-card-note">Encrypted and never shared with buyers.</span>
                <button type="button"
                        class="lv-card-manage"
                        onclick="goTo('account-payouts.html'); event.stopPropagation();">
                  Manage
                </button>
              </div>
            </article>

            <!-- Storefront -->
            <article class="lv-card" onclick="goTo('edit-store.html')">
              <div class="lv-card-header">
                <div class="lv-card-title">Storefront name, branding &amp; first listing</div>
                <div class="lv-card-status" id="status-storefront">Not started</div>
              </div>
              <div class="lv-card-body">
                Choose your storefront name, upload brand visuals, and publish at least one hero listing so shoppers can discover your work.
              </div>
              <div class="lv-card-footer">
                <span class="lv-card-note">You can edit your brand at any time.</span>
                <button type="button"
                        class="lv-card-manage"
                        onclick="goTo('edit-store.html'); event.stopPropagation();">
                  Manage
                </button>
              </div>
            </article>

            <!-- Shipping -->
            <article class="lv-card" onclick="goTo('shipping.html')">
              <div class="lv-card-header">
                <div class="lv-card-title">Shipping methods &amp; delivery promises</div>
                <div class="lv-card-status" id="status-shipping">Not started</div>
              </div>
              <div class="lv-card-body">
                Configure carriers, handling times, and delivery expectations so customers know exactly how and when orders will arrive.
              </div>
              <div class="lv-card-footer">
                <span class="lv-card-note">Applies to all listings by default.</span>
                <button type="button"
                        class="lv-card-manage"
                        onclick="goTo('shipping.html'); event.stopPropagation();">
                  Manage
                </button>
              </div>
            </article>

            <!-- Policies -->
            <article class="lv-card" onclick="goTo('account-policies.html')">
              <div class="lv-card-header">
                <div class="lv-card-title">Policies, returns &amp; customer support</div>
                <div class="lv-card-status" id="status-policies">Not started</div>
              </div>
              <div class="lv-card-body">
                Define your return, exchange, and customer support policies so shoppers feel confident buying from your LumiVue storefront.
              </div>
              <div class="lv-card-footer">
                <span class="lv-card-note">Shown on your public store profile.</span>
                <button type="button"
                        class="lv-card-manage"
                        onclick="goTo('account-policies.html'); event.stopPropagation();">
                  Manage
                </button>
              </div>
            </article>
          </div>

          <p class="lv-footer-note">
            You can return to these steps at any time. Once all required sections are completed and reviewed, your account will be approved and payouts will be activated. Until then, you can still create drafts and refine your listings.
          </p>
        </aside>
      </main>
    </div>
  </div>

  <!-- Firebase CDN SDKs (compat, same pattern as login.html) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <script>
    // LumiVue Firebase config (same project as login.html)
    const firebaseConfig = {
      apiKey: "AIzaSyAMmOyBqyPr5KoIzqnItE4sH1lb83iQAo8",
      authDomain: "lumivue-c8fdf.firebaseapp.com",
      projectId: "lumivue-c8fdf",
      storageBucket: "lumivue-c8fdf.firebasestorage.app",
      messagingSenderId: "120420036736",
      appId: "1:120420036736:web:0fbbc98b02ea54840d3665"
    };

    // Initialize Firebase (compat)
    firebase.initializeApp(firebaseConfig);

    // shared handles
    const auth = firebase.auth();
    const db   = firebase.firestore();
  </script>

  <script>
    // Simple navigation helper used by the cards and buttons
    function goTo(path) {
      window.location.href = path;
    }

    (function () {
      const onboardingBar    = document.getElementById('onboardingBar');
      const onboardingLabel  = document.getElementById('onboardingPercent');
      const overallStatus    = document.getElementById('overallStatusPill');

      const sectionStatusEls = {
        legal:      document.getElementById('status-legal'),
        tax:        document.getElementById('status-tax'),
        payouts:    document.getElementById('status-payouts'),
        storefront: document.getElementById('status-storefront'),
        shipping:   document.getElementById('status-shipping'),
        policies:   document.getElementById('status-policies')
      };

      let currentUser = null;

      function setSectionStatus(el, isDone) {
        if (!el) return;
        el.textContent = isDone ? 'Completed' : 'Not started';
      }

      function updateFromCreatorDoc(data) {
        const sections = ['legal','tax','payouts','storefront','shipping','policies'];
        let completedCount = 0;

        sections.forEach((key) => {
          const info = data && data.sections && data.sections[key];
          const done = info && info.completed === true;
          if (done) completedCount++;
          setSectionStatus(sectionStatusEls[key], done);
        });

        const percent = Math.round((completedCount / sections.length) * 100);

        if (onboardingBar) {
          onboardingBar.style.width = percent + '%';
        }
        if (onboardingLabel) {
          onboardingLabel.textContent = percent + '%';
        }

        if (overallStatus) {
          if (percent === 100) {
            overallStatus.textContent = 'Status: Ready for approval';
          } else if (percent > 0) {
            overallStatus.textContent = 'Status: In progress';
          } else {
            overallStatus.textContent = 'Status: Not approved yet';
          }
        }
      }

      // Store Performance Functions
      function formatNumber(num) {
        if (num >= 1000) {
          return (num / 1000).toFixed(1) + 'k';
        }
        return num.toLocaleString();
      }

      function formatCurrency(amount) {
        if (amount >= 1000) {
          return '$' + (amount / 1000).toFixed(1) + 'k';
        }
        return '$' + amount.toFixed(2);
      }

      async function loadStorePerformance(uid) {
        try {
          // Calculate date 30 days ago
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

          // Load active listings
          const listingsSnap = await db.collection('listings')
            .where('vendorUid', '==', uid)
            .where('status', '==', 'active')
            .get();

          const activeListings = listingsSnap.size;
          
          // Calculate total views (if views are tracked, otherwise use a placeholder)
          // For now, we'll use a simple calculation based on listings
          let totalViews = 0;
          listingsSnap.forEach(doc => {
            const data = doc.data();
            totalViews += (data.views || 0);
          });
          // If no views tracked, show estimated based on listings
          if (totalViews === 0) {
            totalViews = activeListings * 50; // Placeholder calculation
          }

          // Load favorites (if favorites collection exists)
          let totalFavorites = 0;
          try {
            const favoritesSnap = await db.collection('favorites')
              .where('vendorUid', '==', uid)
              .get();
            totalFavorites = favoritesSnap.size;
          } catch (e) {
            // Favorites collection might not exist yet
            console.log('Favorites collection not available');
          }

          // Load orders from last 30 days
          const ordersSnap = await db.collection('orders')
            .where('vendorId', '==', uid)
            .where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
            .get();

          const ordersCount = ordersSnap.size;
          let totalRevenue = 0;
          ordersSnap.forEach(doc => {
            const data = doc.data();
            if (data.paymentStatus === 'paid' || data.paymentStatus === 'Paid') {
              totalRevenue += (data.total || 0);
            }
          });

          // Update metric displays
          const viewsEl = document.getElementById('metricViews');
          const favoritesEl = document.getElementById('metricFavorites');
          const ordersEl = document.getElementById('metricOrders');
          const revenueEl = document.getElementById('metricRevenue');

          if (viewsEl) viewsEl.textContent = formatNumber(totalViews);
          if (favoritesEl) favoritesEl.textContent = formatNumber(totalFavorites);
          if (ordersEl) ordersEl.textContent = formatNumber(ordersCount);
          if (revenueEl) revenueEl.textContent = formatCurrency(totalRevenue);

        } catch (err) {
          console.error('Error loading store performance:', err);
          // Set defaults on error
          const viewsEl = document.getElementById('metricViews');
          const favoritesEl = document.getElementById('metricFavorites');
          const ordersEl = document.getElementById('metricOrders');
          const revenueEl = document.getElementById('metricRevenue');
          if (viewsEl) viewsEl.textContent = '0';
          if (favoritesEl) favoritesEl.textContent = '0';
          if (ordersEl) ordersEl.textContent = '0';
          if (revenueEl) revenueEl.textContent = '$0';
        }
      }

      async function loadRecentActivity(uid) {
        const activityList = document.getElementById('recentActivityList');
        if (!activityList) return;

        const activities = [];

        try {
          // Get recently published listings (simplified query to avoid index issues)
          try {
            const recentListings = await db.collection('listings')
              .where('vendorUid', '==', uid)
              .where('status', '==', 'active')
              .orderBy('createdAt', 'desc')
              .limit(5)
              .get();

            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            recentListings.forEach(doc => {
              const data = doc.data();
              const title = data.title || 'Untitled Product';
              let date = new Date();
              
              // Handle different date formats
              if (data.createdAt) {
                if (data.createdAt.toDate) {
                  date = data.createdAt.toDate();
                } else if (data.createdAt.seconds) {
                  date = new Date(data.createdAt.seconds * 1000);
                } else if (data.createdAt instanceof Date) {
                  date = data.createdAt;
                }
              }

              // Only include listings from last 7 days
              if (date >= sevenDaysAgo) {
                activities.push({
                  type: 'listing',
                  title: `"${title}" approved`,
                  meta: 'Your new listing is now live on LumiVue.',
                  tag: 'Listing live',
                  date: date
                });
              }
            });
          } catch (e) {
            console.log('Could not load recent listings:', e);
            // Try without orderBy if index doesn't exist
            try {
              const allListings = await db.collection('listings')
                .where('vendorUid', '==', uid)
                .where('status', '==', 'active')
                .limit(10)
                .get();

              const sevenDaysAgo = new Date();
              sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

              allListings.forEach(doc => {
                const data = doc.data();
                const title = data.title || 'Untitled Product';
                let date = new Date();
                
                if (data.createdAt) {
                  if (data.createdAt.toDate) {
                    date = data.createdAt.toDate();
                  } else if (data.createdAt.seconds) {
                    date = new Date(data.createdAt.seconds * 1000);
                  }
                }

                if (date >= sevenDaysAgo) {
                  activities.push({
                    type: 'listing',
                    title: `"${title}" approved`,
                    meta: 'Your new listing is now live on LumiVue.',
                    tag: 'Listing live',
                    date: date
                  });
                }
              });
              
              // Sort by date manually
              activities.sort((a, b) => b.date - a.date);
            } catch (e2) {
              console.log('Fallback query also failed:', e2);
            }
          }

          // Get recent orders
          try {
            const recentOrders = await db.collection('orders')
              .where('vendorId', '==', uid)
              .orderBy('createdAt', 'desc')
              .limit(2)
              .get();

            recentOrders.forEach(doc => {
              const data = doc.data();
              let date = new Date();
              
              if (data.createdAt) {
                if (data.createdAt.toDate) {
                  date = data.createdAt.toDate();
                } else if (data.createdAt.seconds) {
                  date = new Date(data.createdAt.seconds * 1000);
                }
              }
              
              const orderTotal = data.total || 0;
              activities.push({
                type: 'order',
                title: 'New order received',
                meta: `Order #${doc.id.slice(0, 8).toUpperCase()} - ${formatCurrency(orderTotal)}`,
                tag: 'Order',
                date: date
              });
            });
          } catch (e) {
            console.log('Could not load recent orders:', e);
            // Try without orderBy
            try {
              const allOrders = await db.collection('orders')
                .where('vendorId', '==', uid)
                .limit(5)
                .get();

              allOrders.forEach(doc => {
                const data = doc.data();
                let date = new Date();
                
                if (data.createdAt) {
                  if (data.createdAt.toDate) {
                    date = data.createdAt.toDate();
                  } else if (data.createdAt.seconds) {
                    date = new Date(data.createdAt.seconds * 1000);
                  }
                }
                
                const orderTotal = data.total || 0;
                activities.push({
                  type: 'order',
                  title: 'New order received',
                  meta: `Order #${doc.id.slice(0, 8).toUpperCase()} - ${formatCurrency(orderTotal)}`,
                  tag: 'Order',
                  date: date
                });
              });
              
              // Sort by date manually
              activities.sort((a, b) => b.date - a.date);
            } catch (e2) {
              console.log('Fallback orders query also failed:', e2);
            }
          }

          // Get recent favorites (if available)
          try {
            const recentFavorites = await db.collection('favorites')
              .where('vendorUid', '==', uid)
              .orderBy('createdAt', 'desc')
              .limit(1)
              .get();

            if (recentFavorites.size > 0) {
              const favData = recentFavorites.docs[0].data();
              let date = new Date();
              
              if (favData.createdAt) {
                if (favData.createdAt.toDate) {
                  date = favData.createdAt.toDate();
                } else if (favData.createdAt.seconds) {
                  date = new Date(favData.createdAt.seconds * 1000);
                }
              }
              
              activities.push({
                type: 'favorite',
                title: 'New favorite',
                meta: 'A shopper saved one of your products.',
                tag: 'Engagement',
                date: date
              });
            }
          } catch (e) {
            // Favorites collection might not exist - this is fine
            console.log('Favorites collection not available:', e);
          }

          // Sort activities by date (most recent first) and limit to 3
          activities.sort((a, b) => b.date - a.date);
          const displayActivities = activities.slice(0, 3);

          // Render activities
          if (displayActivities.length === 0) {
            activityList.innerHTML = `
              <li class="lv-activity-item">
                <div class="lv-activity-main">
                  <strong>No recent activity</strong>
                  <div class="lv-activity-meta">Activity will appear here as you publish listings and receive orders.</div>
                </div>
                <div class="lv-activity-tag">Info</div>
              </li>
            `;
          } else {
            activityList.innerHTML = displayActivities.map(activity => `
              <li class="lv-activity-item">
                <div class="lv-activity-main">
                  <strong>${activity.title}</strong>
                  <div class="lv-activity-meta">${activity.meta}</div>
                </div>
                <div class="lv-activity-tag">${activity.tag}</div>
              </li>
            `).join('');
          }

        } catch (err) {
          console.error('Error loading recent activity:', err);
          // Show friendly message instead of error
          activityList.innerHTML = `
            <li class="lv-activity-item">
              <div class="lv-activity-main">
                <strong>No recent activity</strong>
                <div class="lv-activity-meta">Activity will appear here as you publish listings and receive orders.</div>
              </div>
              <div class="lv-activity-tag">Info</div>
            </li>
          `;
        }
      }

      function initDashboard() {
        auth.onAuthStateChanged(async (user) => {
          currentUser = user;
          
          if (!user) {
            // Show login prompt but don't block page access
            console.log('User not logged in - page accessible but features may be limited');
            return;
          }

          try {
            const docRef = db.collection('creators').doc(user.uid);
            const snap = await docRef.get();
            if (snap.exists) {
              updateFromCreatorDoc(snap.data() || {});
            } else {
              updateFromCreatorDoc({});
            }
          } catch (err) {
            console.error('Error loading vendor account overview', err);
          }

          // Load store performance data
          await loadStorePerformance(user.uid);
          await loadRecentActivity(user.uid);

          // Set up real-time listeners for updates
          // Listen for new listings
          db.collection('listings')
            .where('vendorUid', '==', user.uid)
            .where('status', '==', 'active')
            .onSnapshot(() => {
              loadStorePerformance(user.uid);
              loadRecentActivity(user.uid);
            });

          // Listen for new orders
          db.collection('orders')
            .where('vendorId', '==', user.uid)
            .onSnapshot(() => {
              loadStorePerformance(user.uid);
              loadRecentActivity(user.uid);
            });
        });
      }

      document.addEventListener('DOMContentLoaded', initDashboard);
    })();
  </script>
</body>
</html>
