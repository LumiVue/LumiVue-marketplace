<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Order Details - LumiVue</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <style>
        :root {
            --lv-bg: #f4f1eb;
            --lv-surface: #ffffff;
            --lv-border: #ddd3c6;
            --lv-border-strong: #ccc0b1;
            --lv-text: #2c1e19;
            --lv-text-muted: #7a6a5c;
            --lv-accent: #c98a5a;
            --lv-accent-soft: #fbede1;
            --lv-radius-lg: 14px;
            --lv-shadow-soft: 0 24px 60px rgba(15, 23, 42, 0.18);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background: var(--lv-bg);
            color: var(--lv-text);
        }

        .lv-page {
            min-height: 100vh;
        }

        .lv-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(244, 241, 235, 0.98);
            backdrop-filter: blur(18px);
            border-bottom: 1px solid rgba(221, 211, 198, 0.7);
        }

        .lv-header-inner {
            max-width: 1120px;
            margin: 0 auto;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .lv-logo-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lv-logo-circle {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e6d8c7 0%, #ddd3c6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: var(--lv-text);
        }

        .lv-logo-text {
            font-weight: 700;
            font-size: 16px;
            letter-spacing: 0.5px;
            color: var(--lv-text);
        }

        .lv-container {
            max-width: 1120px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        .lv-page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .lv-page-title {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        .lv-btn {
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .lv-btn-primary {
            background: var(--lv-accent);
            color: #ffffff;
        }

        .lv-btn-secondary {
            background: var(--lv-surface);
            color: var(--lv-text);
            border: 1px solid var(--lv-border-strong);
        }

        .lv-card {
            background: var(--lv-surface);
            border: 1px solid var(--lv-border);
            border-radius: var(--lv-radius-lg);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--lv-shadow-soft);
        }

        .lv-card-title {
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 16px 0;
        }

        .lv-info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--lv-border);
        }

        .lv-info-row:last-child {
            border-bottom: none;
        }

        .lv-info-label {
            font-weight: 600;
            color: var(--lv-text-muted);
            font-size: 13px;
        }

        .lv-info-value {
            font-weight: 600;
            color: var(--lv-text);
            font-size: 14px;
        }

        .lv-order-item {
            display: flex;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--lv-border);
        }

        .lv-order-item:last-child {
            border-bottom: none;
        }

        .lv-order-item-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background: var(--lv-border);
            object-fit: cover;
        }

        .lv-order-item-details {
            flex: 1;
        }

        .lv-order-item-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .lv-order-item-subtitle {
            font-size: 13px;
            color: var(--lv-text-muted);
            margin-bottom: 8px;
        }

        .lv-order-item-price {
            font-weight: 700;
            font-size: 16px;
            color: var(--lv-accent);
        }

        .lv-status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            background: var(--lv-accent-soft);
            color: var(--lv-text);
        }

        .lv-status-badge.processing {
            background: #fef3c7;
            color: #92400e;
        }

        .lv-status-badge.shipped {
            background: #dcfce7;
            color: #166534;
        }

        .lv-status-badge.delivered {
            background: #dbeafe;
            color: #1e40af;
        }

        .lv-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--lv-text-muted);
        }

        .lv-address-block {
            background: var(--lv-accent-soft);
            padding: 16px;
            border-radius: 8px;
            margin-top: 8px;
        }

        .lv-address-line {
            margin-bottom: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="lv-page">
        <header class="lv-header">
            <div class="lv-header-inner">
                <a href="marketplace.html" class="lv-logo-wrap" style="text-decoration: none; color: inherit;">
                    <div class="lv-logo-circle">LV</div>
                    <span class="lv-logo-text">LUMIVUE</span>
                </a>
                <nav>
                    <a href="buyer-dashboard.html" class="lv-btn lv-btn-secondary">Back to Dashboard</a>
                </nav>
            </div>
        </header>

        <main class="lv-container">
            <div class="lv-page-header">
                <h1 class="lv-page-title">Order Details</h1>
                <a href="buyer-dashboard.html" class="lv-btn lv-btn-secondary">Back</a>
            </div>

            <div id="orderDetails">
                <div class="lv-empty-state">
                    <div>Loading order details...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAMmOyBqyPr5KoIzqnItE4sH1lb83iQAo8",
            authDomain: "lumivue-c8fdf.firebaseapp.com",
            projectId: "lumivue-c8fdf",
            storageBucket: "lumivue-c8fdf.firebasestorage.app",
            messagingSenderId: "120420036736",
            appId: "1:120420036736:web:0fbbc98b02ea54840d3665"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Get order ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');

        // Load order details
        async function loadOrderDetails() {
            if (!orderId) {
                document.getElementById('orderDetails').innerHTML = `
                    <div class="lv-empty-state">
                        <div>Order ID not found</div>
                        <a href="buyer-dashboard.html" class="lv-btn lv-btn-primary" style="margin-top: 16px;">Back to Dashboard</a>
                    </div>
                `;
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                document.getElementById('orderDetails').innerHTML = `
                    <div class="lv-empty-state">
                        <div>Please sign in to view order details</div>
                        <a href="login.html" class="lv-btn lv-btn-primary" style="margin-top: 16px;">Sign In</a>
                    </div>
                `;
                return;
            }

            try {
                const orderDoc = await db.collection('orders').doc(orderId).get();
                
                if (!orderDoc.exists) {
                    document.getElementById('orderDetails').innerHTML = `
                        <div class="lv-empty-state">
                            <div>Order not found</div>
                            <a href="buyer-dashboard.html" class="lv-btn lv-btn-primary" style="margin-top: 16px;">Back to Dashboard</a>
                        </div>
                    `;
                    return;
                }

                const order = orderDoc.data();

                // Load buyer data for addresses
                let shippingAddress = null;
                let billingAddress = null;
                try {
                    const buyerDoc = await db.collection('buyers').doc(user.uid).get();
                    if (buyerDoc.exists) {
                        const buyerData = buyerDoc.data();
                        shippingAddress = buyerData.shippingAddress || null;
                        billingAddress = buyerData.billingAddress || null;
                    }
                } catch (e) {
                    console.warn('Could not load buyer addresses:', e);
                }

                renderOrderDetails(order, orderId, shippingAddress, billingAddress);
            } catch (error) {
                console.error('Error loading order details:', error);
                document.getElementById('orderDetails').innerHTML = `
                    <div class="lv-empty-state">
                        <div>Error loading order details</div>
                        <a href="buyer-dashboard.html" class="lv-btn lv-btn-primary" style="margin-top: 16px;">Back to Dashboard</a>
                    </div>
                `;
            }
        }

        function renderOrderDetails(order, orderId, shippingAddress, billingAddress) {
            const orderDate = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString() : 
                            (order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'N/A');
            const currency = order.currency === 'USD' ? '$' : (order.currency || '$');
            const status = order.fulfillmentStatus || order.status || 'processing';
            const paymentStatus = order.paymentStatus || 'unpaid';
            const trackingNo = order.trackingNo || '';
            const carrier = order.carrier || '';
            
            // Format status badge
            let statusClass = 'processing';
            let statusText = 'Processing';
            if (status === 'shipped') {
                statusClass = 'shipped';
                statusText = 'Shipped';
            } else if (status === 'delivered') {
                statusClass = 'delivered';
                statusText = 'Delivered';
            }

            // Render order items
            let itemsHTML = '';
            if (order.items && Array.isArray(order.items) && order.items.length > 0) {
                order.items.forEach(item => {
                    const itemPrice = item.price || 0;
                    const quantity = item.quantity || 1;
                    const itemTotal = itemPrice * quantity;
                    
                    itemsHTML += `
                        <div class="lv-order-item">
                            ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.title || 'Product'}" class="lv-order-item-image" />` : `<div class="lv-order-item-image"></div>`}
                            <div class="lv-order-item-details">
                                <div class="lv-order-item-title">${item.title || 'Product'}</div>
                                ${item.subtitle ? `<div class="lv-order-item-subtitle">${item.subtitle}</div>` : ''}
                                <div style="margin-top: 8px; font-size: 13px; color: var(--lv-text-muted);">
                                    ${currency}${itemPrice.toFixed(2)} × ${quantity} = ${currency}${itemTotal.toFixed(2)}
                                </div>
                            </div>
                            <div class="lv-order-item-price">${currency}${itemTotal.toFixed(2)}</div>
                        </div>
                    `;
                });
            } else {
                itemsHTML = '<div class="lv-empty-state">No items found</div>';
            }

            // Format addresses
            let shippingHTML = '<div style="color: var(--lv-text-muted);">No shipping address saved</div>';
            if (shippingAddress) {
                shippingHTML = `
                    <div class="lv-address-block">
                        ${shippingAddress.name ? `<div class="lv-address-line"><strong>${shippingAddress.name}</strong></div>` : ''}
                        ${shippingAddress.street ? `<div class="lv-address-line">${shippingAddress.street}</div>` : ''}
                        ${shippingAddress.city ? `<div class="lv-address-line">${shippingAddress.city}, ${shippingAddress.state || ''} ${shippingAddress.zip || ''}</div>` : ''}
                        ${shippingAddress.phone ? `<div class="lv-address-line">${shippingAddress.phone}</div>` : ''}
                    </div>
                `;
            }

            let billingHTML = '<div style="color: var(--lv-text-muted);">No billing address saved</div>';
            if (billingAddress) {
                billingHTML = `
                    <div class="lv-address-block">
                        ${billingAddress.name ? `<div class="lv-address-line"><strong>${billingAddress.name}</strong></div>` : ''}
                        ${billingAddress.street ? `<div class="lv-address-line">${billingAddress.street}</div>` : ''}
                        ${billingAddress.city ? `<div class="lv-address-line">${billingAddress.city}, ${billingAddress.state || ''} ${billingAddress.zip || ''}</div>` : ''}
                        ${billingAddress.phone ? `<div class="lv-address-line">${billingAddress.phone}</div>` : ''}
                    </div>
                `;
            }

            const html = `
                <!-- Order Information -->
                <div class="lv-card">
                    <h2 class="lv-card-title">Order Information</h2>
                    <div class="lv-info-row">
                        <span class="lv-info-label">Order Number</span>
                        <span class="lv-info-value">#${orderId.slice(0, 8).toUpperCase()}</span>
                    </div>
                    <div class="lv-info-row">
                        <span class="lv-info-label">Order Date</span>
                        <span class="lv-info-value">${orderDate}</span>
                    </div>
                    <div class="lv-info-row">
                        <span class="lv-info-label">Status</span>
                        <span class="lv-status-badge ${statusClass}">${statusText}</span>
                    </div>
                    ${trackingNo ? `
                    <div class="lv-info-row">
                        <span class="lv-info-label">Tracking Number</span>
                        <span class="lv-info-value">${carrier ? carrier + ' · ' : ''}${trackingNo}</span>
                    </div>
                    ` : ''}
                    <div class="lv-info-row">
                        <span class="lv-info-label">Payment Status</span>
                        <span class="lv-info-value">${paymentStatus.charAt(0).toUpperCase() + paymentStatus.slice(1)}</span>
                    </div>
                    ${order.vendorName ? `
                    <div class="lv-info-row">
                        <span class="lv-info-label">Vendor</span>
                        <span class="lv-info-value">${order.vendorName}</span>
                    </div>
                    ` : ''}
                </div>

                <!-- Order Items -->
                <div class="lv-card">
                    <h2 class="lv-card-title">Order Items</h2>
                    ${itemsHTML}
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--lv-border);">
                        <div class="lv-info-row">
                            <span class="lv-info-label">Subtotal</span>
                            <span class="lv-info-value">${currency}${(order.total || 0).toFixed(2)}</span>
                        </div>
                        <div class="lv-info-row">
                            <span class="lv-info-label">Shipping</span>
                            <span class="lv-info-value">${order.shippingCost ? currency + order.shippingCost.toFixed(2) : 'Calculated at checkout'}</span>
                        </div>
                        <div class="lv-info-row" style="font-size: 18px; font-weight: 700;">
                            <span>Total</span>
                            <span style="color: var(--lv-accent);">${currency}${(order.total || 0).toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="lv-card">
                    <h2 class="lv-card-title">Shipping Address</h2>
                    ${shippingHTML}
                </div>

                <!-- Billing Address -->
                <div class="lv-card">
                    <h2 class="lv-card-title">Billing Address</h2>
                    ${billingHTML}
                </div>
            `;

            document.getElementById('orderDetails').innerHTML = html;
        }

        // Load order when page loads
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadOrderDetails();
            } else {
                document.getElementById('orderDetails').innerHTML = `
                    <div class="lv-empty-state">
                        <div>Please sign in to view order details</div>
                        <a href="login.html" class="lv-btn lv-btn-primary" style="margin-top: 16px;">Sign In</a>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>

